import * as THREE from "three";import {FBXLoader} from "three/addons/loaders/FBXLoader.js";import {OrbitControls} from "three/addons/controls/OrbitControls.js";import {EffectComposer} from "three/addons/postprocessing/EffectComposer.js";import {RenderPass} from "three/addons/postprocessing/RenderPass.js";import {UnrealBloomPass} from "three/addons/postprocessing/UnrealBloomPass.js";import {ShaderPass} from "three/addons/postprocessing/ShaderPass.js";import {Reflector} from "three/addons/objects/Reflector.js";const CONFIG={CAMERA:{FOV:50,NEAR:.1,FAR:5e3},BLOOM:{STRENGTH:.2,RADIUS:.7,THRESHOLD:.9},FISHEYE:{FOV:60,STRENGTH:.165,CYLINDRICAL_RATIO:1},RGB_SPLIT:{AMOUNT:.002},GRAIN:{AMOUNT:.075},FOG:{COLOR:16747520,DENSITY:.0363},CLICK:{THRESHOLD:10,MAX_TIME:500},SOUND:{THROTTLE:50}};function isMobileDevice(){const isMobileUserAgent=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),isTouchDevice="ontouchstart"in window||navigator.maxTouchPoints>0,isSmallScreen=window.innerWidth<768;return isMobileUserAgent||isTouchDevice&&isSmallScreen}const IS_MOBILE=isMobileDevice(),scene=new THREE.Scene;scene.background=new THREE.Color(1710618);const camera=new THREE.PerspectiveCamera(CONFIG.CAMERA.FOV,window.innerWidth/window.innerHeight,CONFIG.CAMERA.NEAR,CONFIG.CAMERA.FAR);scene.add(camera),camera.position.set(0,5,10),camera.updateProjectionMatrix();const renderer=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0});renderer.setSize(window.innerWidth,window.innerHeight),renderer.shadowMap.enabled=!0,renderer.toneMapping=THREE.ACESFilmicToneMapping,renderer.toneMappingExposure=.3,renderer.outputColorSpace=THREE.SRGBColorSpace;const container=document.getElementById("canvas-container");container?container.appendChild(renderer.domElement):document.body.appendChild(renderer.domElement);const controls=new OrbitControls(camera,renderer.domElement);IS_MOBILE?(controls.enabled=!1,renderer.domElement.style.pointerEvents="none"):(controls.enableDamping=!0,controls.dampingFactor=.05,controls.enablePan=!0,controls.panSpeed=.8,controls.screenSpacePanning=!0,controls.mouseButtons={LEFT:THREE.MOUSE.ROTATE,MIDDLE:THREE.MOUSE.DOLLY,RIGHT:THREE.MOUSE.PAN},controls.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"});let isDragging=!1,cameraIsBeingRotated=!1,lastCameraRotationTime=0;if(!IS_MOBILE){controls.addEventListener("start",()=>{cameraIsBeingRotated=!0,isDragging=!0,lastCameraRotationTime=Date.now()}),controls.addEventListener("end",()=>{cameraIsBeingRotated=!1});const domElement=renderer.domElement;let isModifierPressed=!1;domElement.addEventListener("mousedown",event=>{isModifierPressed=event.metaKey||event.ctrlKey,isModifierPressed&&0===event.button?controls.mouseButtons.LEFT=THREE.MOUSE.PAN:isModifierPressed||0!==event.button||(controls.mouseButtons.LEFT=THREE.MOUSE.ROTATE)}),domElement.addEventListener("mouseup",()=>{isModifierPressed||(controls.mouseButtons.LEFT=THREE.MOUSE.ROTATE)})}function kelvinToRgb(kelvin){const temp=kelvin/100;let r,g,b;return temp<=66?(r=255,g=temp,g=99.4708025861*Math.log(g)-161.1195681661,temp<=19?b=0:(b=temp-10,b=138.5177312231*Math.log(b)-305.0447927307)):(r=temp-60,r=329.698727446*Math.pow(r,-.1332047592),g=temp-60,g=288.1221695283*Math.pow(g,-.0755148492),b=255),r=Math.max(0,Math.min(255,r)),g=Math.max(0,Math.min(255,g)),b=Math.max(0,Math.min(255,b)),new THREE.Color(r/255,g/255,b/255)}function pushColorTowardsYellow(color,amount=.25){const yellow=new THREE.Color(16776960),result=color.clone();return result.r+=(yellow.r-color.r)*amount,result.g+=(yellow.g-color.g)*amount,result.b+=(yellow.b-color.b)*amount,result}const keyLight=new THREE.DirectionalLight(kelvinToRgb(6e3),2);keyLight.position.set(8,10,6),keyLight.castShadow=!0,keyLight.shadow.mapSize.width=512,keyLight.shadow.mapSize.height=512,keyLight.shadow.camera.near=.5,keyLight.shadow.camera.far=50,keyLight.shadow.camera.left=-10,keyLight.shadow.camera.right=10,keyLight.shadow.camera.top=10,keyLight.shadow.camera.bottom=-10,scene.add(keyLight);const fillLightColor=pushColorTowardsYellow(kelvinToRgb(3200)),fillLight=new THREE.DirectionalLight(fillLightColor,2.5);fillLight.position.set(-8,6,5),scene.add(fillLight);const backLight=new THREE.DirectionalLight(kelvinToRgb(8e3),2);backLight.position.set(-3,8,-10),scene.add(backLight);const ambientLight=new THREE.AmbientLight(16777215,.5);scene.add(ambientLight);const composer=new EffectComposer(renderer),renderPass=new RenderPass(scene,camera);composer.addPass(renderPass);const bloomPass=new UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),CONFIG.BLOOM.STRENGTH,CONFIG.BLOOM.RADIUS,CONFIG.BLOOM.THRESHOLD);composer.addPass(bloomPass);const fisheyeShader={uniforms:{tDiffuse:{value:null},strength:{value:.3},height:{value:1},aspectRatio:{value:1},cylindricalRatio:{value:1}},vertexShader:"\n        uniform float strength;\n        uniform float height;\n        uniform float aspectRatio;\n        uniform float cylindricalRatio;\n        \n        varying vec3 vUV;\n        varying vec2 vUVDot;\n        \n        void main() {\n            gl_Position = projectionMatrix * (modelViewMatrix * vec4(position, 1.0));\n            \n            float scaledHeight = strength * height;\n            float cylAspectRatio = aspectRatio * cylindricalRatio;\n            float aspectDiagSq = aspectRatio * aspectRatio + 1.0;\n            float diagSq = scaledHeight * scaledHeight * aspectDiagSq;\n            vec2 signedUV = (2.0 * uv + vec2(-1.0, -1.0));\n            \n            float z = 0.5 * sqrt(diagSq + 1.0) + 0.5;\n            float ny = (z - 1.0) / (cylAspectRatio * cylAspectRatio + 1.0);\n            \n            vUVDot = sqrt(ny) * vec2(cylAspectRatio, 1.0) * signedUV;\n            vUV = vec3(0.5, 0.5, 1.0) * z + vec3(-0.5, -0.5, 0.0);\n            vUV.xy += uv;\n        }\n    ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        varying vec3 vUV;\n        varying vec2 vUVDot;\n        \n        void main() {\n            vec3 uv = dot(vUVDot, vUVDot) * vec3(-0.5, -0.5, -1.0) + vUV;\n            gl_FragColor = texture2DProj(tDiffuse, uv);\n        }\n    "},fisheyePass=new ShaderPass(fisheyeShader),horizontalFOV=CONFIG.FISHEYE.FOV,strength=CONFIG.FISHEYE.STRENGTH,cylindricalRatio=CONFIG.FISHEYE.CYLINDRICAL_RATIO,height=Math.tan(THREE.MathUtils.degToRad(horizontalFOV)/2)/camera.aspect;fisheyePass.uniforms.strength.value=strength,fisheyePass.uniforms.height.value=height,fisheyePass.uniforms.aspectRatio.value=camera.aspect,fisheyePass.uniforms.cylindricalRatio.value=cylindricalRatio,composer.addPass(fisheyePass);const rgbSplitShader={uniforms:{tDiffuse:{value:null},amount:{value:.00225}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n    ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform float amount;\n        varying vec2 vUv;\n        \n        void main() {\n            vec2 offset = amount * vec2(1.0, 0.0);\n            float r = texture2D(tDiffuse, vUv + offset).r;\n            float g = texture2D(tDiffuse, vUv).g;\n            float b = texture2D(tDiffuse, vUv - offset).b;\n            gl_FragColor = vec4(r, g, b, 1.0);\n        }\n    "},rgbSplitPass=new ShaderPass(rgbSplitShader);composer.addPass(rgbSplitPass);const vignetteShader={uniforms:{tDiffuse:{value:null},offset:{value:.93},darkness:{value:.6}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n    ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform float offset;\n        uniform float darkness;\n        varying vec2 vUv;\n        \n        void main() {\n            vec4 texel = texture2D(tDiffuse, vUv);\n            vec2 uv = (vUv - vec2(0.5)) * vec2(1.0);\n            float dist = length(uv);\n            float vignette = smoothstep(offset, darkness + offset, dist);\n            texel.rgb = mix(texel.rgb, texel.rgb * (1.0 - vignette), 0.8);\n            gl_FragColor = texel;\n        }\n    "},vignettePass=new ShaderPass(vignetteShader);composer.addPass(vignettePass);const badTVShader={uniforms:{tDiffuse:{value:null},time:{value:0},distortion:{value:1.5},distortion2:{value:2},speed:{value:.1},rollSpeed:{value:.05}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n    ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform float time;\n        uniform float distortion;\n        uniform float distortion2;\n        uniform float speed;\n        uniform float rollSpeed;\n        varying vec2 vUv;\n        \n        // Ashima 2D Simplex Noise\n        vec3 mod289(vec3 x) {\n            return x - floor(x * (1.0 / 289.0)) * 289.0;\n        }\n        \n        vec2 mod289(vec2 x) {\n            return x - floor(x * (1.0 / 289.0)) * 289.0;\n        }\n        \n        vec3 permute(vec3 x) {\n            return mod289(((x*34.0)+1.0)*x);\n        }\n        \n        float snoise(vec2 v) {\n            const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);\n            vec2 i = floor(v + dot(v, C.yy));\n            vec2 x0 = v - i + dot(i, C.xx);\n            \n            vec2 i1;\n            i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);\n            vec4 x12 = x0.xyxy + C.xxzz;\n            x12.xy -= i1;\n            \n            i = mod289(i);\n            vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));\n            \n            vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);\n            m = m*m;\n            m = m*m;\n            \n            vec3 x = 2.0 * fract(p * C.www) - 1.0;\n            vec3 h = abs(x) - 0.5;\n            vec3 ox = floor(x + 0.5);\n            vec3 a0 = x - ox;\n            \n            m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);\n            \n            vec3 g;\n            g.x = a0.x * x0.x + h.x * x0.y;\n            g.yz = a0.yz * x12.xz + h.yz * x12.yw;\n            return 130.0 * dot(m, g);\n        }\n        \n        void main() {\n            vec2 p = vUv;\n            float ty = time * speed;\n            float yt = p.y - ty;\n            \n            // Smooth distortion\n            float offset = snoise(vec2(yt * 3.0, 0.0)) * 0.2;\n            \n            // Boost distortion\n            offset = offset * distortion * offset * distortion * offset;\n            \n            // Add fine grain distortion\n            offset += snoise(vec2(yt * 50.0, 0.0)) * distortion2 * 0.001;\n            \n            // Combine distortion on X with roll on Y\n            gl_FragColor = texture2D(tDiffuse, vec2(fract(p.x + offset), fract(p.y - time * rollSpeed)));\n        }\n    "},grainShader={uniforms:{tDiffuse:{value:null},time:{value:0},amount:{value:.075}},vertexShader:"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n    ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform float time;\n        uniform float amount;\n        varying vec2 vUv;\n        \n        float random(vec2 st) {\n            return fract(sin(dot(st.xy, vec2(12.9898, 78.233))) * 43758.5453123);\n        }\n        \n        void main() {\n            vec4 color = texture2D(tDiffuse, vUv);\n            \n            // Generate random grain\n            float grain = random(vUv * vec2(200.0, 200.0) + time);\n            \n            // Overlay blending mode - only affects blacks and doesn't gray\n            float grainValue = (grain - 0.5) * amount;\n            \n            // Apply dark grain with overlay-like behavior\n            gl_FragColor = color - vec4(grainValue * 0.5);\n        }\n    "},grainPass=new ShaderPass(grainShader);grainPass.uniforms.amount.value=CONFIG.GRAIN.AMOUNT;let grainTime=0;composer.addPass(grainPass),scene.fog=new THREE.FogExp2(CONFIG.FOG.COLOR,CONFIG.FOG.DENSITY);const panelBlurShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(window.innerWidth,window.innerHeight)},rectUV:{value:new THREE.Vector4(0,0,0,0)},blurSize:{value:12}},vertexShader:"\n        varying vec2 vUv;\n        void main(){\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n    ",fragmentShader:"\n        uniform sampler2D tDiffuse;\n        uniform vec2 resolution;\n        uniform vec4 rectUV; // x0,y0,x1,y1\n        uniform float blurSize;\n        varying vec2 vUv;\n\n        bool inRect(vec2 uv, vec4 r){\n            return uv.x >= r.x && uv.x <= r.z && uv.y >= r.y && uv.y <= r.w;\n        }\n\n        void main(){\n            vec4 base = texture2D(tDiffuse, vUv);\n            if (!inRect(vUv, rectUV)){\n                gl_FragColor = base;\n                return;\n            }\n            // Higher quality approximate Gaussian blur (32 taps)\n            vec2 px = blurSize / resolution;\n            vec4 c = vec4(0.0);\n            float w0 = 0.140; // center\n            float w1 = 0.110; // 1 px offsets\n            float w2 = 0.075; // 1 px diagonals\n            float w3 = 0.060; // 2 px offsets\n            float w4 = 0.040; // 2 px diagonals\n            float w5 = 0.025; // 3 px offsets\n            float w6 = 0.015; // 3 px diagonals\n            \n            // center\n            c += texture2D(tDiffuse, vUv) * w0;\n            \n            // 1 px cross\n            c += texture2D(tDiffuse, vUv + vec2( px.x, 0.0)) * w1;\n            c += texture2D(tDiffuse, vUv + vec2(-px.x, 0.0)) * w1;\n            c += texture2D(tDiffuse, vUv + vec2(0.0 ,  px.y)) * w1;\n            c += texture2D(tDiffuse, vUv + vec2(0.0 , -px.y)) * w1;\n            \n            // 1 px diagonals\n            c += texture2D(tDiffuse, vUv + vec2( px.x,  px.y)) * w2;\n            c += texture2D(tDiffuse, vUv + vec2(-px.x,  px.y)) * w2;\n            c += texture2D(tDiffuse, vUv + vec2( px.x, -px.y)) * w2;\n            c += texture2D(tDiffuse, vUv + vec2(-px.x, -px.y)) * w2;\n            \n            // 2 px cross\n            c += texture2D(tDiffuse, vUv + vec2( 2.0*px.x, 0.0)) * w3;\n            c += texture2D(tDiffuse, vUv + vec2(-2.0*px.x, 0.0)) * w3;\n            c += texture2D(tDiffuse, vUv + vec2(0.0 ,  2.0*px.y)) * w3;\n            c += texture2D(tDiffuse, vUv + vec2(0.0 , -2.0*px.y)) * w3;\n            \n            // 2 px diagonals\n            c += texture2D(tDiffuse, vUv + vec2( 2.0*px.x,  2.0*px.y)) * w4;\n            c += texture2D(tDiffuse, vUv + vec2(-2.0*px.x,  2.0*px.y)) * w4;\n            c += texture2D(tDiffuse, vUv + vec2( 2.0*px.x, -2.0*px.y)) * w4;\n            c += texture2D(tDiffuse, vUv + vec2(-2.0*px.x, -2.0*px.y)) * w4;\n\n            // 3 px cross\n            c += texture2D(tDiffuse, vUv + vec2( 3.0*px.x, 0.0)) * w5;\n            c += texture2D(tDiffuse, vUv + vec2(-3.0*px.x, 0.0)) * w5;\n            c += texture2D(tDiffuse, vUv + vec2(0.0 ,  3.0*px.y)) * w5;\n            c += texture2D(tDiffuse, vUv + vec2(0.0 , -3.0*px.y)) * w5;\n\n            // 3 px diagonals\n            c += texture2D(tDiffuse, vUv + vec2( 3.0*px.x,  3.0*px.y)) * w6;\n            c += texture2D(tDiffuse, vUv + vec2(-3.0*px.x,  3.0*px.y)) * w6;\n            c += texture2D(tDiffuse, vUv + vec2( 3.0*px.x, -3.0*px.y)) * w6;\n            c += texture2D(tDiffuse, vUv + vec2(-3.0*px.x, -3.0*px.y)) * w6;\n            \n            gl_FragColor = c;\n        }\n    "},ENABLE_PANEL_BLUR=!1;let panelBlurPass=null;const raycaster=new THREE.Raycaster,mouse=new THREE.Vector2;let mouseX=0,mouseY=0,hoveredMesh=null,hoverFadeProgress=0,boundingBoxHelper=null,cornerIndicators=[],cornerLabels=[],labelsLayerEl=null,lockRing=null,lockRingTargetScale=1,lockRingThickness=.01,lockRingTargetThickness=.01,lockRingAnim={active:!1,startTime:0,duration:200,fromScale:1,toScale:1,fromThick:.01,toThick:.01,fromOpacity:0,toOpacity:0};const ENABLE_HOVER_LIGHT=!0,ENABLE_SPOT_SHADOW=!1,ENABLE_GHOST_POINTS=!1;let infoPanelEnabled=!0,autoRotateEnabled=!0,assetsReady=!1,__sharedGlassMaterial=null,__windshieldGlassMaterial=null;function getStableLocalCenter(targetMesh){const tmpBox=new THREE.Box3,tmpVec=new THREE.Vector3;tmpBox.setFromObject(targetMesh);let worldCenter=tmpBox.getCenter(new THREE.Vector3);if(!(Number.isFinite(worldCenter.x)&&Number.isFinite(worldCenter.y)&&Number.isFinite(worldCenter.z))&&targetMesh.geometry){targetMesh.geometry.computeBoundingBox();const gb=targetMesh.geometry.boundingBox;gb&&(worldCenter=gb.getCenter(new THREE.Vector3),targetMesh.localToWorld(worldCenter))}Number.isFinite(worldCenter.x)&&Number.isFinite(worldCenter.y)&&Number.isFinite(worldCenter.z)||(worldCenter=targetMesh.getWorldPosition(new THREE.Vector3));const localCenter=targetMesh.worldToLocal(worldCenter.clone());return Number.isFinite(localCenter.x)&&Number.isFinite(localCenter.y)&&Number.isFinite(localCenter.z)?localCenter:tmpVec.set(0,0,0)}let uiCogMesh=null,uiCogTargetPx=141;function initializeUICog(){if(!uiCogMesh)try{const img=new Image;img.onload=()=>{const canvas=document.createElement("canvas");canvas.width=uiCogTargetPx,canvas.height=uiCogTargetPx;const ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);const pad=Math.floor(.08*canvas.width);ctx.drawImage(img,pad,pad,canvas.width-2*pad,canvas.height-2*pad),ctx.globalCompositeOperation="source-atop",ctx.fillStyle="#ffd700",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.globalCompositeOperation="source-over";const tex=new THREE.CanvasTexture(canvas);tex.colorSpace=THREE.SRGBColorSpace;const mat=new THREE.MeshBasicMaterial({map:tex,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide}),geo=new THREE.PlaneGeometry(1,1);uiCogMesh=new THREE.Mesh(geo,mat),camera.add(uiCogMesh),window.uiCogMesh=uiCogMesh,uiCogMesh.position.set(0,0,-1),uiCogMesh.renderOrder=2e3,uiCogMesh.frustumCulled=!1},img.src="Media/porsche-3-logo-svg-vector.svg"}catch(_){}}function layoutUICog(){if(!uiCogMesh)return;uiCogMesh.position.z=-1;const vFov=THREE.MathUtils.degToRad(camera.fov||50),viewH=2*Math.tan(vFov/2)*1,viewW=viewH*(camera.aspect||window.innerWidth/Math.max(1,window.innerHeight)),targetHWorld=viewH/Math.max(1,window.innerHeight)*uiCogTargetPx,targetWWorld=targetHWorld;uiCogMesh.scale.set(targetWWorld,targetHWorld,1);const offsetX=(50-window.innerWidth/2+uiCogTargetPx/2)*(viewW/Math.max(1,window.innerWidth)),offsetY=(-window.innerHeight/2+50+uiCogTargetPx/2)*(viewH/Math.max(1,window.innerHeight));uiCogMesh.position.x=offsetX,uiCogMesh.position.y=offsetY}function buildLockRingGeometry(baseRadius,thicknessRatio,segments=32){const outer=baseRadius,inner=baseRadius*(1-Math.max(0,Math.min(1,thicknessRatio))),positions=new Float32Array(2*segments*3);for(let i=0;i<segments;i++){const a=i/segments*Math.PI*2,cos=Math.cos(a),sin=Math.sin(a),ox=cos*outer,oz=sin*outer,ix=cos*inner,iz=sin*inner,idx=2*i*3;positions[idx+0]=ox,positions[idx+1]=0,positions[idx+2]=oz,positions[idx+3]=ix,positions[idx+4]=0,positions[idx+5]=iz}const geom=new THREE.BufferGeometry;return geom.setAttribute("position",new THREE.BufferAttribute(positions,3)),geom}let boundingBoxAnimation={isAnimating:!1,startTime:0,duration:200,startScale:new THREE.Vector3(0,0,0),targetScale:new THREE.Vector3(1,1,1),currentScale:new THREE.Vector3(0,0,0),cornerIndicators:[]};function easeOut(t){return 1-Math.pow(1-t,3)}function startBoundingBoxAnimation(){boundingBoxAnimation.isAnimating=!0,boundingBoxAnimation.startTime=performance.now(),boundingBoxAnimation.startScale.set(0,0,0),boundingBoxAnimation.targetScale.set(1,1,1),boundingBoxAnimation.currentScale.set(0,0,0),boundingBoxAnimation.cornerIndicators=[],boundingBoxAnimation.cornerLabels=[]}let enableScreenOutline=!1,modelMaxDimension=1,warningMesh=null,warningOriginalEmissive=null,warningOriginalEmissiveIntensity=0,hoverPointLight=null,hoverLightOwner=null,hoverLightLastUpdate=0;function cleanupHoverLights(){const toRemove=[];scene.traverse(n=>{if(n.isLight&&n.userData&&n.userData.isHoverLight){if(hoverPointLight&&n===hoverPointLight)return;toRemove.push(n)}}),toRemove.forEach(l=>{l.parent&&l.parent.remove(l),l.dispose?.()})}let currentText="",targetText="",textDecodeIndex=0,textDecodeSpeed=3;const orbitsGroup=new THREE.Group;orbitsGroup.userData.isHelper=!0;let orbitParents=[];function createPlanetaryOrbitsAround(object){const modelBox=(new THREE.Box3).setFromObject(object),modelSize=modelBox.getSize(new THREE.Vector3),modelCenter=modelBox.getCenter(new THREE.Vector3),maxDim=Math.max(modelSize.x,modelSize.y,modelSize.z),sphereRadius=.8*maxDim;function makeOrbit(radius,colorHex,tiltEuler,dashCount,spinSpeed){const parent=new THREE.Group;parent.rotation.set(tiltEuler.x,tiltEuler.y,tiltEuler.z);const dashLength=.5*(radius*(2*Math.PI/dashCount)),lineMat=new THREE.LineBasicMaterial({color:colorHex,transparent:!0,opacity:.8});for(let i=0;i<dashCount;i++){const theta=i/dashCount*Math.PI*2,center=new THREE.Vector3(Math.cos(theta)*radius,0,Math.sin(theta)*radius),tangent=new THREE.Vector3(-Math.sin(theta),0,Math.cos(theta)).normalize(),start=center.clone().addScaledVector(tangent,.5*-dashLength),end=center.clone().addScaledVector(tangent,.5*dashLength),g=(new THREE.BufferGeometry).setFromPoints([start,end]),seg=new THREE.Line(g,lineMat.clone());parent.add(seg)}const circlePts=(new THREE.Path).absarc(0,0,radius,0,2*Math.PI,!1).getPoints(256),circleGeom=(new THREE.BufferGeometry).setFromPoints(circlePts.map(p=>new THREE.Vector3(p.x,0,p.y))),circleMat=new THREE.LineBasicMaterial({color:colorHex,opacity:.18,transparent:!0}),circle=new THREE.LineLoop(circleGeom,circleMat);parent.add(circle),orbitsGroup.add(parent),orbitParents.push({parent:parent,spinSpeed:spinSpeed})}orbitsGroup.position.set(modelCenter.x,modelCenter.y+.05*modelSize.y,modelCenter.z);const r2=.965*sphereRadius,r3=.94*sphereRadius;makeOrbit(.995*sphereRadius,16753920,new THREE.Euler(.45,0,.12),64,.12),makeOrbit(r2,16766720,new THREE.Euler(.1,.6,-.2),96,-.08),makeOrbit(r3,16746564,new THREE.Euler(-.35,-.15,.4),128,.06)}scene.add(orbitsGroup);const scatteredCrossGroup=new THREE.Group;scatteredCrossGroup.userData.isHelper=!0;let scatteredCrosses=[];function createScatteredCrossesAround(object,count=32){const modelSize=(new THREE.Box3).setFromObject(object).getSize(new THREE.Vector3),modelRadius=.65*Math.max(modelSize.x,modelSize.y,modelSize.z),targetRadius=1.26*modelRadius;scatteredCrosses.forEach(c=>scatteredCrossGroup.remove(c)),scatteredCrosses=[];const offset=2/count,increment=Math.PI*(3-Math.sqrt(5));for(let i=0;i<count;i++){const y=i*offset-1+offset/2,r=Math.sqrt(1-y*y),phi=i*increment,pos=new THREE.Vector3(Math.cos(phi)*r,y,Math.sin(phi)*r).multiplyScalar(targetRadius),lineLength=.3*(.04*modelRadius),points=[new THREE.Vector3(-lineLength,0,0),new THREE.Vector3(lineLength,0,0),new THREE.Vector3(0,-lineLength,0),new THREE.Vector3(0,lineLength,0),new THREE.Vector3(0,0,-lineLength),new THREE.Vector3(0,0,lineLength)],geometry=(new THREE.BufferGeometry).setFromPoints(points),material=new THREE.LineBasicMaterial({color:16766720,transparent:!0,opacity:.6}),cross=new THREE.LineSegments(geometry,material);cross.position.copy(pos),cross.raycast=()=>{},scatteredCrossGroup.add(cross),scatteredCrosses.push(cross)}}scene.add(scatteredCrossGroup);let tooltipTypewriterActive=!1,tooltipCurrentText="",tooltipTargetText="",tooltipTypewriterIndex=0,tooltipTypewriterSpeed=1.5;const hoverSound=new Audio("Media/261590__kwahmah_02__little-glitch.flac");hoverSound.volume=.36;let audioContext=null,soundThrottleLastPlayed={};const SOUND_THROTTLE=CONFIG.SOUND.THROTTLE;function initAudioContext(){audioContext||(audioContext=new(window.AudioContext||window.webkitAudioContext)),"suspended"===audioContext.state&&audioContext.resume()}function createUISound(type){if(initAudioContext(),!audioContext)return;const now=performance.now();if(soundThrottleLastPlayed[type]&&now-soundThrottleLastPlayed[type]<SOUND_THROTTLE)return;soundThrottleLastPlayed[type]=now;const now_time=audioContext.currentTime;switch(type){case"reveal":const osc1=audioContext.createOscillator(),gain1=audioContext.createGain();osc1.type="square",osc1.frequency.setValueAtTime(800,now_time),osc1.frequency.exponentialRampToValueAtTime(1200,now_time+.08),gain1.gain.setValueAtTime(0,now_time),gain1.gain.linearRampToValueAtTime(.09,now_time+.01),gain1.gain.exponentialRampToValueAtTime(.001,now_time+.08),osc1.connect(gain1),gain1.connect(audioContext.destination),osc1.start(now_time),osc1.stop(now_time+.08);break;case"close":const osc2=audioContext.createOscillator(),gain2=audioContext.createGain();osc2.type="square",osc2.frequency.setValueAtTime(1200,now_time),osc2.frequency.exponentialRampToValueAtTime(600,now_time+.1),gain2.gain.setValueAtTime(0,now_time),gain2.gain.linearRampToValueAtTime(.075,now_time+.01),gain2.gain.exponentialRampToValueAtTime(.001,now_time+.1),osc2.connect(gain2),gain2.connect(audioContext.destination),osc2.start(now_time),osc2.stop(now_time+.1);break;case"hover":const osc3=audioContext.createOscillator(),gain3=audioContext.createGain();osc3.type="square",osc3.frequency.setValueAtTime(1800,now_time),gain3.gain.setValueAtTime(0,now_time),gain3.gain.linearRampToValueAtTime(.06,now_time+.005),gain3.gain.exponentialRampToValueAtTime(.001,now_time+.03),osc3.connect(gain3),gain3.connect(audioContext.destination),osc3.start(now_time),osc3.stop(now_time+.03);break;case"select":const osc4=audioContext.createOscillator(),gain4=audioContext.createGain();osc4.type="square",osc4.frequency.setValueAtTime(2200,now_time),gain4.gain.setValueAtTime(0,now_time),gain4.gain.linearRampToValueAtTime(.075,now_time+.002),gain4.gain.exponentialRampToValueAtTime(.001,now_time+.02),osc4.connect(gain4),gain4.connect(audioContext.destination),osc4.start(now_time),osc4.stop(now_time+.02)}}let uiHoverSoundLastPlayed=0;const UI_HOVER_SOUND_THROTTLE=150,ambientMusic=new Audio("Media/674414__gregorquendel__sci-fi-soundscape-drone-pad-harmonic-008-iv-designed-atmospheres.mp3");ambientMusic.volume=.4,ambientMusic.loop=!0,ambientMusic.preload="auto",ambientMusic.crossOrigin="anonymous";let partSelectSoundBuffer=null,partSelectSoundReversedBuffer=null;async function loadPartSelectSound(){if(!partSelectSoundBuffer)try{if(initAudioContext(),!audioContext)return;const response=await fetch("Media/419823__glaneur-de-sons__bbb-soft-05.wav"),arrayBuffer=await response.arrayBuffer();partSelectSoundBuffer=await audioContext.decodeAudioData(arrayBuffer);const length=partSelectSoundBuffer.length,reversed=audioContext.createBuffer(partSelectSoundBuffer.numberOfChannels,length,partSelectSoundBuffer.sampleRate);for(let channel=0;channel<partSelectSoundBuffer.numberOfChannels;channel++){const channelData=partSelectSoundBuffer.getChannelData(channel),reversedData=reversed.getChannelData(channel);for(let i=0;i<length;i++)reversedData[i]=channelData[length-1-i]}partSelectSoundReversedBuffer=reversed}catch(error){console.error("Failed to load part selection sound:",error)}}function playPartSelectSound(reverse=!1){if(initAudioContext(),!audioContext)return void(partSelectSoundBuffer||partSelectSoundReversedBuffer||loadPartSelectSound().then(()=>{audioContext&&playPartSelectSound(reverse)}));if("suspended"===audioContext.state&&audioContext.resume(),!partSelectSoundBuffer&&!partSelectSoundReversedBuffer)return void loadPartSelectSound().then(()=>playPartSelectSound(reverse));const buffer=reverse?partSelectSoundReversedBuffer:partSelectSoundBuffer;if(!buffer)return;const source=audioContext.createBufferSource(),gainNode=audioContext.createGain();source.buffer=buffer,source.connect(gainNode),gainNode.connect(audioContext.destination),gainNode.gain.value=.6,source.start(0)}let isMusicPlaying=!1;function initializeMusicPlayer(){const musicPlayer=document.getElementById("music-player"),musicIcon=document.getElementById("music-icon");musicPlayer&&musicIcon?(musicIcon.innerHTML='<i data-feather="music"></i>',"undefined"!=typeof feather&&feather.replace(),musicPlayer.addEventListener("click",()=>{isMusicPlaying?(ambientMusic.pause(),isMusicPlaying=!1,musicPlayer.classList.remove("playing"),musicIcon.innerHTML='<i data-feather="music"></i>',"undefined"!=typeof feather&&feather.replace(),console.log("Music paused")):ambientMusic.play().then(()=>{isMusicPlaying=!0,musicPlayer.classList.add("playing"),musicIcon.innerHTML='<i data-feather="pause"></i>',"undefined"!=typeof feather&&feather.replace(),console.log("Music started")}).catch(e=>{console.error("Failed to play music:",e)})}),console.log("Music player initialized")):console.error("Music player elements not found")}function initializeFullscreen(){const fullscreenButton=document.getElementById("fullscreen-button"),fullscreenIcon=document.getElementById("fullscreen-icon");function toggleFullscreen(){document.fullscreenElement?document.exitFullscreen().then(()=>{console.log("Exited fullscreen"),fullscreenIcon.innerHTML='<i data-feather="maximize"></i>',"undefined"!=typeof feather&&feather.replace()}).catch(err=>{console.error("Error exiting fullscreen:",err)}):document.documentElement.requestFullscreen().then(()=>{console.log("Entered fullscreen"),fullscreenIcon.innerHTML='<i data-feather="minimize"></i>',"undefined"!=typeof feather&&feather.replace()}).catch(err=>{console.error("Error entering fullscreen:",err)})}fullscreenButton&&fullscreenIcon?(fullscreenIcon.innerHTML='<i data-feather="maximize"></i>',"undefined"!=typeof feather&&feather.replace(),fullscreenButton.addEventListener("click",toggleFullscreen),document.addEventListener("keydown",event=>{"j"!==event.key.toLowerCase()||event.ctrlKey||event.metaKey||event.altKey||"INPUT"!==event.target.tagName&&"TEXTAREA"!==event.target.tagName&&(event.preventDefault(),toggleFullscreen())}),document.addEventListener("fullscreenchange",()=>{document.fullscreenElement?fullscreenIcon.innerHTML='<i data-feather="minimize"></i>':fullscreenIcon.innerHTML='<i data-feather="maximize"></i>',"undefined"!=typeof feather&&feather.replace()}),console.log("Fullscreen functionality initialized (J key)")):console.error("Fullscreen elements not found")}function initializeInfoToggle(){const infoBtn=document.getElementById("info-button"),infoIcon=document.getElementById("info-icon"),partContainer=document.getElementById("part-container");if(!infoBtn||!infoIcon||!partContainer)return;if(infoIcon.innerHTML='<i data-feather="info"></i>',"undefined"!=typeof feather)try{feather.replace()}catch(_){}const updateButtonState=()=>{infoPanelEnabled?infoBtn.classList.remove("off"):infoBtn.classList.add("off")};updateButtonState(),infoBtn.addEventListener("click",()=>{infoPanelEnabled=!infoPanelEnabled,updateButtonState(),infoPanelEnabled?hoveredMesh&&partContainer.classList.add("visible"):partContainer.classList.remove("visible")})}const uiHoverBlinkTargets=[];function initializeUIHoverBlink(){["music-player","rotate-button","info-button","fullscreen-button","book-button"].forEach(id=>{const el=document.getElementById(id);el&&(el.addEventListener("mouseenter",()=>{el.classList.add("ui-hover-blink"),uiHoverBlinkTargets.includes(el)||uiHoverBlinkTargets.push(el),createUISound("hover")}),el.addEventListener("mouseleave",()=>{el.classList.remove("ui-hover-blink"),el.style.opacity=""}))})}function initializeBookButton(){const bookButton=document.getElementById("book-button"),bookIcon=document.getElementById("book-icon");bookButton&&bookIcon?(bookIcon.innerHTML='<i data-feather="book"></i>',"undefined"!=typeof feather&&feather.replace(),bookButton.addEventListener("click",event=>{event.stopPropagation(),console.log("Book button clicked!"),showPorscheHistory()}),console.log("Book button initialized")):console.warn("Book button elements not found")}function initializeRotateToggle(){const btn=document.getElementById("rotate-button"),icon=document.getElementById("rotate-icon");if(!btn||!icon)return;if(icon.innerHTML='<i data-feather="repeat"></i>',"undefined"!=typeof feather)try{feather.replace()}catch(_){}const sync=()=>{autoRotateEnabled?btn.classList.remove("paused"):btn.classList.add("paused")};sync(),btn.addEventListener("click",()=>{autoRotateEnabled=!autoRotateEnabled,sync()})}function capitalizeFirstLetter(string){return string?string.charAt(0).toUpperCase()+string.slice(1):string}function getStatusIcon(statusText){return statusText.includes("Maintenance")||statusText.includes("Warning")?"alert-triangle":statusText.includes("Operational")||statusText.includes("Excellent")||statusText.includes("Good Condition")||statusText.includes("Optimal")?"check-circle":"help-circle"}function onMouseMove(event){if(IS_MOBILE)return;const tooltip=document.getElementById("tooltip");if(tooltip&&(tooltip.style.left=`${event.clientX}px`,tooltip.style.top=`${event.clientY}px`),outOfFundsVisible){if(hoveredMesh&&hoveredMesh!==clickedMesh){hoveredMesh.userData.originalMaterial&&(hoveredMesh.material&&hoveredMesh.material.dispose(),hoveredMesh.material=hoveredMesh.userData.originalMaterial.clone(),void 0!==hoveredMesh.userData.originalCastShadow&&(hoveredMesh.castShadow=hoveredMesh.userData.originalCastShadow,hoveredMesh.userData.originalCastShadow=void 0),hoveredMesh.userData.originalMaterial=null),boundingBoxHelper&&boundingBoxHelper.parent&&(boundingBoxHelper.parent.remove(boundingBoxHelper),boundingBoxHelper=null),cornerIndicators.forEach(indicator=>{indicator.parent&&indicator.parent.remove(indicator)}),cornerIndicators=[],cornerLabels.length&&labelsLayerEl&&cornerLabels.forEach(({el:el})=>{el&&el.parentNode&&labelsLayerEl.removeChild(el)}),cornerLabels=[],hoverPointLight&&(scene.remove(hoverPointLight),hoverPointLight.dispose?.(),hoverPointLight=null,hoverLightOwner=null),tooltip&&tooltip.classList.remove("visible");const crossEl=document.getElementById("cursor-cross");crossEl&&crossEl.classList.remove("hovering","warning","good","neutral"),hoveredMesh=null,hoverFadeProgress=0}}else{if(porscheHistoryVisible){const crossEl=document.getElementById("cursor-cross");crossEl&&crossEl.classList.remove("hovering","warning","good","neutral");const container=document.getElementById("porsche-history-container");if(container){const centerX=window.innerWidth/2,centerY=window.innerHeight/2,normalizedX=(event.clientX-centerX)/centerX,normalizedY=(event.clientY-centerY)/centerY;porscheHistoryMouseFollow.targetX=normalizedX*0,porscheHistoryMouseFollow.targetY=normalizedY*0;const gsap=window.gsap||window.GSAP;gsap&&(porscheHistoryFollowAnimation&&porscheHistoryFollowAnimation.kill(),porscheHistoryFollowAnimation=gsap.to(porscheHistoryMouseFollow,{x:porscheHistoryMouseFollow.targetX,y:porscheHistoryMouseFollow.targetY,duration:.3,ease:"power2.out",onUpdate:()=>{const gsapY=gsap.getProperty(container,"y")||0;container.style.transform=`translate(calc(-50% + ${porscheHistoryMouseFollow.x}px), calc(-50% + ${gsapY+porscheHistoryMouseFollow.y}px))`;const scrollbar=document.getElementById("porsche-history-scrollbar");if(scrollbar&&"none"!==scrollbar.style.display){const containerRect=container.getBoundingClientRect();scrollbar.style.left=`${containerRect.right+4}px`}}}))}if(hoveredMesh&&hoveredMesh!==clickedMesh){hoveredMesh.userData.originalMaterial&&(hoveredMesh.material&&hoveredMesh.material.dispose(),hoveredMesh.material=hoveredMesh.userData.originalMaterial.clone(),void 0!==hoveredMesh.userData.originalCastShadow&&(hoveredMesh.castShadow=hoveredMesh.userData.originalCastShadow,hoveredMesh.userData.originalCastShadow=void 0),hoveredMesh.userData.originalMaterial=null),boundingBoxHelper&&boundingBoxHelper.parent&&(boundingBoxHelper.parent.remove(boundingBoxHelper),boundingBoxHelper=null),cornerIndicators.forEach(indicator=>{indicator.parent&&indicator.parent.remove(indicator)}),cornerIndicators=[],cornerLabels.length&&labelsLayerEl&&cornerLabels.forEach(({el:el})=>{el&&el.parentNode&&labelsLayerEl.removeChild(el)}),cornerLabels=[],hoverPointLight&&(scene.remove(hoverPointLight),hoverPointLight.dispose?.(),hoverPointLight=null,hoverLightOwner=null),tooltip&&tooltip.classList.remove("visible");const crossEl=document.getElementById("cursor-cross");crossEl&&crossEl.classList.remove("hovering","warning","good","neutral"),hoveredMesh=null,hoverFadeProgress=0}return}if(menuVisible){const crossEl=document.getElementById("cursor-cross");crossEl&&crossEl.classList.remove("hovering","warning","good","neutral");const container=document.getElementById("part-menu-container");if(container){const centerX=window.innerWidth/2,centerY=window.innerHeight/2,normalizedX=(event.clientX-centerX)/centerX,normalizedY=(event.clientY-centerY)/centerY;menuMouseFollow.targetX=normalizedX*MENU_MOUSE_FOLLOW_STRENGTH,menuMouseFollow.targetY=normalizedY*MENU_MOUSE_FOLLOW_STRENGTH;const gsap=window.gsap||window.GSAP;gsap&&(menuFollowAnimation&&menuFollowAnimation.kill(),menuFollowAnimation=gsap.to(menuMouseFollow,{x:menuMouseFollow.targetX,y:menuMouseFollow.targetY,duration:.3,ease:"power2.out",onUpdate:()=>{const gsapY=gsap.getProperty(container,"y")||0;container.style.transform=`translate(calc(-50% + ${menuMouseFollow.x}px), calc(-50% + ${gsapY+menuMouseFollow.y}px))`}}))}if(hoveredMesh&&hoveredMesh!==clickedMesh){hoveredMesh.userData.originalMaterial&&(hoveredMesh.material&&hoveredMesh.material.dispose(),hoveredMesh.material=hoveredMesh.userData.originalMaterial.clone(),void 0!==hoveredMesh.userData.originalCastShadow&&(hoveredMesh.castShadow=hoveredMesh.userData.originalCastShadow,hoveredMesh.userData.originalCastShadow=void 0),hoveredMesh.userData.originalMaterial=null),boundingBoxHelper&&boundingBoxHelper.parent&&(boundingBoxHelper.parent.remove(boundingBoxHelper),boundingBoxHelper=null),cornerIndicators.forEach(indicator=>{indicator.parent&&indicator.parent.remove(indicator)}),cornerIndicators=[],cornerLabels.length&&labelsLayerEl&&cornerLabels.forEach(({el:el})=>{el&&el.parentNode&&labelsLayerEl.removeChild(el)}),cornerLabels=[],hoverPointLight&&(scene.remove(hoverPointLight),hoverPointLight.dispose?.(),hoverPointLight=null,hoverLightOwner=null),tooltip&&tooltip.classList.remove("visible");const crossEl=document.getElementById("cursor-cross");crossEl&&crossEl.classList.remove("hovering","warning","good","neutral"),hoveredMesh=null,hoverFadeProgress=0}return}if(mouseX=event.clientX/window.innerWidth*2-1,mouseY=-event.clientY/window.innerHeight*2+1,mouse.x=mouseX,mouse.y=mouseY,raycaster.setFromCamera(mouse,camera),porscheModel){const validIntersect=raycaster.intersectObject(porscheModel,!0).find(hit=>function(obj){if(!obj||!obj.isMesh)return!1;let n=obj;for(;n;){if(n.userData?.isHelper)return!1;const nm=(n.name||"").toLowerCase();if(nm.includes("reference")||nm.includes("ghostpointcloud")||nm.includes("bounding")||nm.includes("hoverlight")||nm.includes("podium"))return!1;if(n===orbitsGroup||n===scatteredCrossGroup)return!1;n=n.parent}const bbox=(new THREE.Box3).setFromObject(obj),size=bbox.getSize(new THREE.Vector3),center=bbox.getCenter(new THREE.Vector3),largest=Math.max(size.x,size.y,size.z),nearOrigin=center.length()<.05*modelMaxDimension,verySmall=largest<.03*modelMaxDimension,geom=obj.geometry,vertCount=geom?.attributes?.position?.count||0;return!(nearOrigin&&verySmall||vertCount>0&&vertCount<30)}(hit.object));document.getElementById("cursor-cross");if(validIntersect){const currentHovered=validIntersect.object;if(currentHovered.name&&currentHovered.name.toLowerCase().includes("plateau")){if(hoveredMesh&&hoveredMesh.userData.originalMaterial){hoveredMesh.material&&hoveredMesh.material.dispose();const originalMat=hoveredMesh.userData.originalMaterial.clone();hoveredMesh.material=originalMat,void 0!==hoveredMesh.userData.originalCastShadow&&(hoveredMesh.castShadow=hoveredMesh.userData.originalCastShadow,hoveredMesh.userData.originalCastShadow=void 0),hoveredMesh.userData.originalMaterial=null}boundingBoxHelper&&boundingBoxHelper.parent&&(boundingBoxHelper.parent.remove(boundingBoxHelper),boundingBoxHelper=null),cornerIndicators.forEach(indicator=>{indicator.parent&&indicator.parent.remove(indicator)}),cornerLabels.length&&labelsLayerEl&&cornerLabels.forEach(({el:el})=>labelsLayerEl.removeChild(el)),cornerLabels=[],cornerIndicators=[],hoverPointLight&&(scene.remove(hoverPointLight),hoverPointLight.dispose?.(),hoverPointLight=null,hoverLightOwner=null,cleanupHoverLights());const crossEl=document.getElementById("cursor-cross");crossEl&&crossEl.classList.remove("hovering","warning","good","neutral"),targetText="",currentText="",textDecodeIndex=0;const tooltip=document.getElementById("tooltip");if(tooltip){tooltip.classList.remove("visible"),tooltipTypewriterActive=!1,tooltipCurrentText="",tooltipTargetText="",tooltipTypewriterIndex=0;const tooltipStatus=document.getElementById("tooltip-status"),tooltipIcon=document.getElementById("tooltip-icon");tooltipStatus&&tooltipStatus.classList.remove("blinking"),tooltipIcon&&(tooltipIcon.classList.remove("blinking","warning","good"),tooltipIcon.innerHTML="")}const partContainerEl=document.getElementById("part-container");partContainerEl&&partContainerEl.classList.remove("visible");const partNameEl=document.getElementById("part-name");return partNameEl&&partNameEl.classList.remove("warning","good"),hoveredMesh=null,void(hoverFadeProgress=0)}if(currentHovered!==hoveredMesh){currentHovered.name;let randomStatus;const hash=currentHovered.uuid.split("").reduce((a,b)=>(a=(a<<5)-a+b.charCodeAt(0))&a,0),statusCategory=Math.abs(hash)%3;if(0===statusCategory){const goodStatuses=["Status: Operational","Status: Excellent","Status: Good Condition","Status: Optimal Performance"];randomStatus=goodStatuses[Math.abs(hash)%goodStatuses.length]}else if(1===statusCategory){const warningStatuses=["Status: Requires Maintenance","Status: Warning - Check Soon"];randomStatus=warningStatuses[Math.abs(hash)%warningStatuses.length]}else{const neutralStatuses=["Status: Needs Inspection","Status: Minor Wear"];randomStatus=neutralStatuses[Math.abs(hash)%neutralStatuses.length]}const tooltip=document.getElementById("tooltip"),tooltipPartName=document.getElementById("tooltip-part-name"),tooltipStatus=document.getElementById("tooltip-status"),tooltipIcon=document.getElementById("tooltip-icon");if(tooltip&&tooltipPartName&&tooltipStatus&&tooltipIcon){tooltip.classList.add("visible"),tooltipPartName.style.display="inline-block",tooltipPartName.style.transform="scale(1.2)",tooltipPartName.style.transformOrigin="left center",tooltipTargetText=capitalizeFirstLetter(currentHovered.name||"Unknown Part"),tooltipCurrentText="",tooltipTypewriterIndex=0,tooltipTypewriterActive=!0,tooltipPartName.classList.remove("warning","good"),randomStatus.includes("Maintenance")||randomStatus.includes("Warning")?(tooltipPartName.classList.add("warning"),tooltipStatus.classList.add("blinking"),tooltipIcon.classList.add("blinking")):randomStatus.includes("Operational")||randomStatus.includes("Excellent")||randomStatus.includes("Good Condition")||randomStatus.includes("Optimal")?(tooltipPartName.classList.add("good"),tooltipStatus.classList.remove("blinking"),tooltipIcon.classList.remove("blinking"),tooltipStatus.style.opacity="1",tooltipIcon.style.opacity="1"):(tooltipStatus.classList.remove("blinking"),tooltipIcon.classList.remove("blinking"),tooltipStatus.style.opacity="1",tooltipIcon.style.opacity="1"),tooltipStatus.textContent=randomStatus,tooltipStatus.classList.remove("warning","good");const iconName=getStatusIcon(randomStatus);tooltipIcon.innerHTML=`<i data-feather="${iconName}"></i>`,tooltipIcon.classList.remove("warning","good"),randomStatus.includes("Maintenance")||randomStatus.includes("Warning")?tooltipIcon.classList.add("warning"):(randomStatus.includes("Operational")||randomStatus.includes("Excellent")||randomStatus.includes("Good Condition")||randomStatus.includes("Optimal"))&&tooltipIcon.classList.add("good"),"undefined"!=typeof feather&&feather.replace();const crossEl=document.getElementById("cursor-cross");crossEl&&(crossEl.classList.remove("warning","good","neutral","hovering"),randomStatus.includes("Maintenance")||randomStatus.includes("Warning")?(tooltipStatus.classList.add("warning"),crossEl.classList.add("warning")):randomStatus.includes("Operational")||randomStatus.includes("Excellent")||randomStatus.includes("Good Condition")||randomStatus.includes("Optimal")?(tooltipStatus.classList.add("good"),crossEl.classList.add("good")):crossEl.classList.add("neutral"))}if(hoveredMesh&&hoveredMesh.userData.originalMaterial){hoveredMesh.userData.originalMaterial;Array.isArray(hoveredMesh.material)?hoveredMesh.material.forEach((m,i)=>{hoveredMesh.userData.originalMaterial[i]&&(m.dispose(),m=hoveredMesh.userData.originalMaterial[i].clone())}):(hoveredMesh.material.dispose(),hoveredMesh.material=hoveredMesh.userData.originalMaterial.clone(),void 0!==hoveredMesh.userData.originalCastShadow&&(hoveredMesh.castShadow=hoveredMesh.userData.originalCastShadow,hoveredMesh.userData.originalCastShadow=void 0),hoveredMesh.material.isMeshPhysicalMaterial&&(hoveredMesh.material.envMap=scene.environment,hoveredMesh.material.envMapIntensity=1.2,hoveredMesh.material.roughness=0,hoveredMesh.material.metalness=1,hoveredMesh.material.sheen=2.5,hoveredMesh.material.sheenRoughness=.3,hoveredMesh.material.sheenColor=new THREE.Color(16766720),hoveredMesh.material.iridescence=1,hoveredMesh.material.iridescenceIOR=1.3,hoveredMesh.material.iridescenceThicknessRange=[100,500],hoveredMesh.material.needsUpdate=!0))}if(hoveredMesh=currentHovered,hoveredMesh.isMesh&&hoveredMesh.material){hoveredMesh.userData.originalMaterial=hoveredMesh.material.clone(),hoverSound.currentTime=0,hoverSound.play().catch(e=>console.log("Sound playback failed:",e));const partContainerEl=document.getElementById("part-container"),partNameEl=document.getElementById("part-name");partNameEl&&(targetText="Porsche 911",currentText="",textDecodeIndex=0,partNameEl.classList.remove("warning","good")),partContainerEl&&infoPanelEnabled&&partContainerEl.classList.add("visible");const partInfoEl=document.getElementById("part-info");if(partInfoEl){const info=[];if(info.push("─────────────────────────────────────────"),info.push("  PART NAME:"),info.push(`    ${capitalizeFirstLetter(hoveredMesh.name||"Unnamed Part")}`),info.push("─────────────────────────────────────────"),info.push("  POSITION:"),info.push(`    x: ${hoveredMesh.position.x.toFixed(2)}`),info.push(`    y: ${hoveredMesh.position.y.toFixed(2)}`),info.push(`    z: ${hoveredMesh.position.z.toFixed(2)}`),info.push(""),info.push("  ROTATION:"),info.push(`    x: ${hoveredMesh.rotation.x.toFixed(2)}`),info.push(`    y: ${hoveredMesh.rotation.y.toFixed(2)}`),info.push(`    z: ${hoveredMesh.rotation.z.toFixed(2)}`),info.push(""),info.push("  SCALE:"),info.push(`    x: ${hoveredMesh.scale.x.toFixed(2)}`),info.push(`    y: ${hoveredMesh.scale.y.toFixed(2)}`),info.push(`    z: ${hoveredMesh.scale.z.toFixed(2)}`),hoveredMesh.geometry){const geometry=hoveredMesh.geometry;if(info.push("─────────────────────────────────────────"),info.push("  GEOMETRY TYPE:"),info.push(`    ${geometry.type}`),geometry.attributes&&geometry.attributes.position){const vertexCount=geometry.attributes.position.count,faces=geometry.index?geometry.index.count/3:vertexCount/3;info.push(""),info.push(`  VERTICES: ${vertexCount}`),info.push(`  FACES: ${faces.toFixed(0)}`)}if(geometry.boundingBox){const width=(geometry.boundingBox.max.x-geometry.boundingBox.min.x).toFixed(2),height=(geometry.boundingBox.max.y-geometry.boundingBox.min.y).toFixed(2),depth=(geometry.boundingBox.max.z-geometry.boundingBox.min.z).toFixed(2);info.push(""),info.push("  BOUNDING BOX:"),info.push(`    w: ${width}`),info.push(`    h: ${height}`),info.push(`    d: ${depth}`)}}hoveredMesh.material&&(info.push("─────────────────────────────────────────"),info.push(`  MATERIAL: ${hoveredMesh.material.type}`)),info.push("─────────────────────────────────────────"),info.push(`  UUID: ${hoveredMesh.uuid.substring(0,8)}...`),info.push("─────────────────────────────────────────"),partInfoEl.innerHTML="";const delayPerLine=.5/info.length;info.forEach((line,index)=>{const lineEl=document.createElement("div");lineEl.className="info-line",lineEl.textContent=line,lineEl.style.animationDelay=index*delayPerLine+"s",partInfoEl.appendChild(lineEl)})}let statusColor=16766720;randomStatus.includes("Maintenance")||randomStatus.includes("Warning")?statusColor=16729156:(randomStatus.includes("Operational")||randomStatus.includes("Excellent")||randomStatus.includes("Good Condition")||randomStatus.includes("Optimal"))&&(statusColor=4521796);const wireframeMat=new THREE.MeshStandardMaterial({color:statusColor,wireframe:!0,emissive:statusColor,emissiveIntensity:7.5});if(void 0===hoveredMesh.userData.originalCastShadow&&(hoveredMesh.userData.originalCastShadow=hoveredMesh.castShadow),hoveredMesh.material=wireframeMat,hoveredMesh.castShadow=!1,boundingBoxHelper&&boundingBoxHelper.parent.remove(boundingBoxHelper),cornerIndicators.forEach(indicator=>{indicator.parent&&indicator.parent.remove(indicator)}),cornerLabels.length&&labelsLayerEl&&cornerLabels.forEach(({el:el})=>labelsLayerEl.removeChild(el)),cornerLabels=[],cornerIndicators=[],hoveredMesh.geometry){hoveredMesh.geometry.computeBoundingBox();const bbox=hoveredMesh.geometry.boundingBox,center=bbox.getCenter(new THREE.Vector3),box=new THREE.BoxGeometry(bbox.max.x-bbox.min.x,bbox.max.y-bbox.min.y,bbox.max.z-bbox.min.z),bboxColor=statusColor,edges=new THREE.EdgesGeometry(box),boundingBoxWireframe=new THREE.LineSegments(edges,new THREE.LineBasicMaterial({color:bboxColor,transparent:!0,opacity:1,linewidth:3}));boundingBoxWireframe.raycast=()=>{},boundingBoxWireframe.position.copy(center),hoveredMesh.add(boundingBoxWireframe),boundingBoxHelper=boundingBoxWireframe,boundingBoxHelper.scale.set(0,0,0),startBoundingBoxAnimation();{const worldBbox=(new THREE.Box3).setFromObject(hoveredMesh),worldSize=(worldBbox.getCenter(new THREE.Vector3),worldBbox.getSize(new THREE.Vector3)),largestDim=Math.max(worldSize.x,worldSize.y,worldSize.z),lightDistance=1.2*Math.max(2,4*largestDim),lightIntensity=.8;cleanupHoverLights(),hoverPointLight||(hoverPointLight=new THREE.PointLight(statusColor,lightIntensity,lightDistance),hoverPointLight.castShadow=!1,hoverPointLight.decay=2,hoverPointLight.userData.isHoverLight=!0,hoverPointLight.name="HoverLight"),hoverPointLight.parent!==hoveredMesh&&(hoverPointLight.parent&&hoverPointLight.parent.remove(hoverPointLight),hoveredMesh.add(hoverPointLight),hoverLightOwner=hoveredMesh),hoverPointLight.color.setHex(statusColor);const now=performance.now();if(hoverLightOwner!==hoveredMesh||now-hoverLightLastUpdate>100){hoverPointLight.intensity=lightIntensity,hoverPointLight.distance=lightDistance;const localCenter=getStableLocalCenter(hoveredMesh);hoverPointLight.position.copy(localCenter),hoverLightLastUpdate=now}}[new THREE.Vector3(bbox.min.x,bbox.min.y,bbox.min.z),new THREE.Vector3(bbox.max.x,bbox.min.y,bbox.min.z),new THREE.Vector3(bbox.min.x,bbox.max.y,bbox.min.z),new THREE.Vector3(bbox.max.x,bbox.max.y,bbox.min.z),new THREE.Vector3(bbox.min.x,bbox.min.y,bbox.max.z),new THREE.Vector3(bbox.max.x,bbox.min.y,bbox.max.z),new THREE.Vector3(bbox.min.x,bbox.max.y,bbox.max.z),new THREE.Vector3(bbox.max.x,bbox.max.y,bbox.max.z)].forEach(corner=>{bbox.getCenter(new THREE.Vector3);const centerPoint=corner.clone(),points=[centerPoint.clone(),centerPoint.clone().add(new THREE.Vector3(.0375,0,0)),centerPoint.clone(),centerPoint.clone().add(new THREE.Vector3(-.0375,0,0)),centerPoint.clone(),centerPoint.clone().add(new THREE.Vector3(0,.0375,0)),centerPoint.clone(),centerPoint.clone().add(new THREE.Vector3(0,-.0375,0)),centerPoint.clone(),centerPoint.clone().add(new THREE.Vector3(0,0,.0375)),centerPoint.clone(),centerPoint.clone().add(new THREE.Vector3(0,0,-.0375))],crossMaterial=new THREE.LineBasicMaterial({color:bboxColor,transparent:!0,opacity:1,linewidth:3}),geometry=(new THREE.BufferGeometry).setFromPoints(points),cross=new THREE.LineSegments(geometry,crossMaterial);cross.position.set(0,0,0),cross.raycast=()=>{},cross.scale.set(0,0,0),hoveredMesh.add(cross),cornerIndicators.push(cross),boundingBoxAnimation.cornerIndicators.push(cross),labelsLayerEl||(labelsLayerEl=document.getElementById("labels-layer"),labelsLayerEl||(labelsLayerEl=document.createElement("div"),labelsLayerEl.id="labels-layer",labelsLayerEl.style.position="fixed",labelsLayerEl.style.left="0",labelsLayerEl.style.top="0",labelsLayerEl.style.width="100%",labelsLayerEl.style.height="100%",labelsLayerEl.style.pointerEvents="none",document.body.appendChild(labelsLayerEl)));const labelAnchor=new THREE.Object3D;labelAnchor.position.copy(centerPoint),hoveredMesh.add(labelAnchor);const labelEl=document.createElement("div");labelEl.className="corner-label",labelEl.style.position="absolute",labelEl.style.transform="translate(-50%, -50%)",labelEl.style.fontFamily="monospace",labelEl.style.fontSize="11px";const labelColorCss="#"+("000000"+bboxColor.toString(16)).slice(-6);labelEl.style.color=labelColorCss,labelEl.style.background="transparent",labelEl.style.padding="0",labelEl.style.borderRadius="0",labelEl.style.whiteSpace="nowrap",labelsLayerEl.appendChild(labelEl);const labelEntry={anchor:labelAnchor,el:labelEl};cornerLabels.push(labelEntry),boundingBoxAnimation.cornerLabels||(boundingBoxAnimation.cornerLabels=[]),boundingBoxAnimation.cornerLabels.push(labelEntry)}),lockRing&&lockRing.material&&(lockRingAnim.active=!0,lockRingAnim.startTime=performance.now(),lockRingAnim.fromScale=Math.max(lockRing.scale.x||1,1.15),lockRingAnim.toScale=1,lockRingAnim.fromThick=lockRingThickness,lockRingAnim.toThick=.03,lockRingAnim.fromOpacity=lockRing.material.opacity,lockRingAnim.toOpacity=1,lockRing.material.color.setHex(statusColor),lockRing.material.needsUpdate=!0)}}}}else{const tooltip=document.getElementById("tooltip");if(tooltip){tooltip.classList.remove("visible"),tooltipTypewriterActive=!1,tooltipCurrentText="",tooltipTargetText="",tooltipTypewriterIndex=0;const tooltipStatus=document.getElementById("tooltip-status"),tooltipIcon=document.getElementById("tooltip-icon"),tooltipPartName=document.getElementById("tooltip-part-name");tooltipStatus&&tooltipStatus.classList.remove("blinking"),tooltipIcon&&(tooltipIcon.classList.remove("blinking","warning","good"),tooltipIcon.innerHTML=""),tooltipPartName&&(tooltipPartName.style.transform="")}if(hoveredMesh&&hoveredMesh.userData.originalMaterial){hoveredMesh.material&&hoveredMesh.material.dispose();const originalMat=hoveredMesh.userData.originalMaterial.clone();hoveredMesh.material=originalMat,hoveredMesh.userData.originalMaterial=null}if(lockRing){lockRingAnim.active=!1,lockRing.scale.set(1,1,1),lockRingThickness=.02;const baseR=lockRing.userData.baseRadius||1,inner=baseR*(1-lockRingThickness),outer=baseR,segs=128,newGeom=new THREE.RingGeometry(inner,outer,segs);lockRing.geometry.dispose(),lockRing.geometry=newGeom,lockRing.material.opacity=0,lockRing.material.color.setHex(16766720),lockRing.material.needsUpdate=!0}boundingBoxHelper&&boundingBoxHelper.parent&&(boundingBoxHelper.parent.remove(boundingBoxHelper),boundingBoxHelper=null),cornerIndicators.forEach(indicator=>{indicator.parent&&indicator.parent.remove(indicator)}),cornerLabels.length&&labelsLayerEl&&cornerLabels.forEach(({el:el})=>labelsLayerEl.removeChild(el)),cornerLabels=[],cornerIndicators=[],hoverPointLight&&(scene.remove(hoverPointLight),hoverPointLight.dispose?.(),hoverPointLight=null,hoverLightOwner=null,cleanupHoverLights());const crossEl=document.getElementById("cursor-cross");crossEl&&crossEl.classList.remove("hovering","warning","good","neutral"),targetText="",currentText="",textDecodeIndex=0;const partContainerEl=document.getElementById("part-container");partContainerEl&&partContainerEl.classList.remove("visible");const partNameEl=document.getElementById("part-name");partNameEl&&partNameEl.classList.remove("warning","good"),hoveredMesh=null,hoverFadeProgress=0}}}}hoverSound.preload="auto",hoverSound.crossOrigin="anonymous",document.addEventListener("click",()=>{hoverSound.play().then(()=>{hoverSound.pause(),hoverSound.currentTime=0}).catch(e=>console.log("Initial audio test:",e))},{once:!0}),IS_MOBILE||window.addEventListener("mousemove",onMouseMove);let clickedMesh=null,menuVisible=!1,menuMouseFollow={x:0,y:0,targetX:0,targetY:0},menuFollowAnimation=null;const MENU_MOUSE_FOLLOW_STRENGTH=15;let porscheHistoryMouseFollow={x:0,y:0,targetX:0,targetY:0},porscheHistoryFollowAnimation=null,autoRotateStateBeforeMenu=!0,clickedMeshOriginalMaterial=null,cameraOriginalState={position:new THREE.Vector3,target:new THREE.Vector3,saved:!1},cameraFocusAnimation=null,mouseDownPos={x:0,y:0},mouseDownTime=0;const CLICK_THRESHOLD=CONFIG.CLICK.THRESHOLD,CLICK_MAX_TIME=CONFIG.CLICK.MAX_TIME;function onMouseDown(event){0===event.button&&(mouseDownPos.x=event.clientX,mouseDownPos.y=event.clientY,mouseDownTime=Date.now(),isDragging=!1)}function checkDrag(event){if(0===mouseDownTime)return!1;const dx=event.clientX-mouseDownPos.x,dy=event.clientY-mouseDownPos.y;return Math.sqrt(dx*dx+dy*dy)>CLICK_THRESHOLD&&(isDragging=!0,!0)}function onMouseClick(event){if(IS_MOBILE)return;const target=event.target;if(target.closest("#part-menu-overlay")||target.closest("#porsche-history-overlay")||target.closest("#out-of-funds-overlay")||target.closest("#music-player")||target.closest("#fullscreen-button")||target.closest("#info-button")||target.closest("#rotate-button")||target.closest("#book-button"))return"part-menu-backdrop"===target.id&&hidePartMenu(),"porsche-history-backdrop"===target.id&&hidePorscheHistory(),"out-of-funds-backdrop"===target.id&&hideOutOfFundsPopup(),mouseDownTime=0,void(isDragging=!1);if(menuVisible)return mouseDownTime=0,void(isDragging=!1);let timeSinceDown=0,distance=0;if(mouseDownTime>0){timeSinceDown=Date.now()-mouseDownTime;const dx=event.clientX-mouseDownPos.x,dy=event.clientY-mouseDownPos.y;distance=Math.sqrt(dx*dx+dy*dy)}const shouldBlock=mouseDownTime>0&&(isDragging||distance>CLICK_THRESHOLD||timeSinceDown>CLICK_MAX_TIME)||cameraIsBeingRotated;if(mouseDownTime=0,shouldBlock){isDragging=!1;const timeSinceRotation=Date.now()-lastCameraRotationTime;return void console.log("Click blocked:",{isDragging:isDragging,distance:distance,timeSinceDown:timeSinceDown,cameraIsBeingRotated:cameraIsBeingRotated,timeSinceRotation:timeSinceRotation})}if(mouse.x=event.clientX/window.innerWidth*2-1,mouse.y=-event.clientY/window.innerHeight*2+1,raycaster.setFromCamera(mouse,camera),porscheModel){const intersects=raycaster.intersectObject(porscheModel,!0);const validIntersect=intersects.find(hit=>function(obj){if(!obj||!obj.isMesh)return!1;let n=obj;for(;n;){if(n.userData?.isHelper)return!1;const nm=(n.name||"").toLowerCase();if(nm.includes("reference")||nm.includes("ghostpointcloud")||nm.includes("bounding")||nm.includes("hoverlight")||nm.includes("podium"))return!1;if(n===orbitsGroup||n===scatteredCrossGroup)return!1;n=n.parent}const bbox=(new THREE.Box3).setFromObject(obj),size=bbox.getSize(new THREE.Vector3),center=bbox.getCenter(new THREE.Vector3),largest=Math.max(size.x,size.y,size.z),nearOrigin=center.length()<.05*modelMaxDimension,verySmall=largest<.03*modelMaxDimension,geom=obj.geometry,vertCount=geom?.attributes?.position?.count||0;return!(nearOrigin&&verySmall||vertCount>0&&vertCount<30)}(hit.object));validIntersect?(clickedMesh=validIntersect.object,console.log("Valid click detected on:",clickedMesh.name),showPartMenu(clickedMesh)):console.log("Click detected but no valid mesh found. Total intersects:",intersects.length)}}function getPartMenuOptions(mesh){const partName=mesh.name||"Unknown Part",hash=mesh.uuid.split("").reduce((a,b)=>(a=(a<<5)-a+b.charCodeAt(0))&a,0),statusCategory=Math.abs(hash)%3,baseOptions=[{title:"View Details",desc:"Inspect part specifications and status",action:()=>console.log("View details:",partName)},{title:"Maintenance History",desc:"View service records and maintenance log",action:()=>console.log("Maintenance history:",partName)},{title:"Replace Part",desc:"Order replacement or schedule installation",action:()=>console.log("Replace part:",partName)}];return 1===statusCategory?baseOptions.unshift({title:"⚠️ Immediate Action Required",desc:"This part requires urgent attention",action:()=>console.log("Urgent action:",partName)}):0===statusCategory&&baseOptions.push({title:"Optimize Performance",desc:"Enhance part efficiency and longevity",action:()=>console.log("Optimize:",partName)}),baseOptions}function showPartMenu(mesh){const gsap=window.gsap||window.GSAP;if(!gsap)return void console.warn("GSAP not loaded");if(autoRotateStateBeforeMenu=autoRotateEnabled,autoRotateEnabled=!1,cameraOriginalState.saved||(cameraOriginalState.position.copy(camera.position),cameraOriginalState.target.copy(controls.target),cameraOriginalState.saved=!0),mesh&&mesh.isMesh){const bbox=(new THREE.Box3).setFromObject(mesh),partCenter=bbox.getCenter(new THREE.Vector3),partSize=bbox.getSize(new THREE.Vector3),maxSize=Math.max(partSize.x,partSize.y,partSize.z),safeSize=maxSize>.001?maxSize:1,currentDistance=camera.position.distanceTo(partCenter);let directionToPart=partCenter.clone().sub(camera.position).clone().normalize();(!directionToPart.length()||!Number.isFinite(directionToPart.x)||Math.abs(directionToPart.length())<.1)&&directionToPart.set(.3,.5,1).normalize();const minZoomDistance=2.5*safeSize,targetDistance=Math.min(.6*currentDistance,Math.max(minZoomDistance,.6*currentDistance)),finalDistance=Math.min(targetDistance,.9*currentDistance),newCameraPos=partCenter.clone().sub(directionToPart.multiplyScalar(finalDistance));cameraFocusAnimation&&cameraFocusAnimation.kill();const camPos={x:camera.position.x,y:camera.position.y,z:camera.position.z},camTarget={x:controls.target.x,y:controls.target.y,z:controls.target.z},targetPos={x:newCameraPos.x,y:newCameraPos.y,z:newCameraPos.z},targetTarget={x:partCenter.x,y:partCenter.y,z:partCenter.z},cameraTimeline=gsap.timeline();cameraTimeline.to(camPos,{x:targetPos.x,y:targetPos.y,z:targetPos.z,duration:1,ease:"power2.inOut",onUpdate:()=>{Number.isFinite(camPos.x)&&Number.isFinite(camPos.y)&&Number.isFinite(camPos.z)&&(camera.position.set(camPos.x,camPos.y,camPos.z),camera.updateProjectionMatrix())}},0).to(camTarget,{x:targetTarget.x,y:targetTarget.y,z:targetTarget.z,duration:1,ease:"power2.inOut",onUpdate:()=>{Number.isFinite(camTarget.x)&&Number.isFinite(camTarget.y)&&Number.isFinite(camTarget.z)&&(controls.target.set(camTarget.x,camTarget.y,camTarget.z),controls.update())}},0),cameraFocusAnimation=cameraTimeline}if(mesh&&mesh.isMesh&&mesh.material){clickedMeshOriginalMaterial||(clickedMeshOriginalMaterial=mesh.userData.originalMaterial?mesh.userData.originalMaterial.clone():mesh.material.clone());const hash=mesh.uuid.split("").reduce((a,b)=>(a=(a<<5)-a+b.charCodeAt(0))&a,0),statusCategory=Math.abs(hash)%3;let statusColor=16766720;1===statusCategory?statusColor=16729156:0===statusCategory&&(statusColor=4521796);const currentMat=mesh.material;let needsNewMaterial=!0;if(currentMat.emissive&&currentMat.emissiveIntensity&&currentMat.emissive.getHex()===statusColor&&Math.abs(currentMat.emissiveIntensity-7.5)<.1&&(needsNewMaterial=!1),needsNewMaterial){const isWireframe=currentMat.wireframe,emissiveMat=isWireframe?new THREE.MeshStandardMaterial({color:statusColor,wireframe:!0,emissive:statusColor,emissiveIntensity:7.5}):currentMat.clone();isWireframe||(emissiveMat.emissive=new THREE.Color(statusColor),emissiveMat.emissiveIntensity=7.5),currentMat.dispose&&currentMat.dispose(),isWireframe&&(void 0===mesh.userData.originalCastShadow&&(mesh.userData.originalCastShadow=mesh.castShadow),mesh.castShadow=!1),mesh.material=emissiveMat}}menuVisible=!0,document.body.classList.add("menu-open");const crossEl=document.getElementById("cursor-cross");crossEl&&crossEl.classList.remove("hovering","warning","good","neutral");const tooltip=document.getElementById("tooltip");tooltip&&tooltip.classList.remove("visible");const overlay=document.getElementById("part-menu-overlay"),container=document.getElementById("part-menu-container"),title=document.getElementById("part-menu-title"),optionsContainer=document.getElementById("part-menu-options"),backdrop=document.getElementById("part-menu-backdrop"),closeBtn=document.getElementById("part-menu-close");if(menuFollowAnimation&&(menuFollowAnimation.kill(),menuFollowAnimation=null),menuMouseFollow.x=0,menuMouseFollow.y=0,menuMouseFollow.targetX=0,menuMouseFollow.targetY=0,!(overlay&&container&&title&&optionsContainer))return void console.warn("Menu elements not found",{overlay:overlay,container:container,title:title,optionsContainer:optionsContainer});console.log("Showing menu for:",mesh.name);const partName=mesh.name||"Unknown Part";title.textContent=partName;const options=getPartMenuOptions(mesh);optionsContainer.innerHTML="",options.forEach((opt,index)=>{const optionEl=document.createElement("div");optionEl.className="part-menu-option",(opt.title.includes("⚠️")||opt.title.includes("Immediate Action"))&&optionEl.classList.add("warning-option");let titleHtml=opt.title;opt.title.includes("⚠️")&&(titleHtml=opt.title.replace("⚠️",'<span class="warning-icon-wrapper"><i data-feather="alert-triangle" class="warning-icon-feather"></i></span>')),optionEl.innerHTML=`\n            <div class="part-menu-option-title">${titleHtml}</div>\n            <div class="part-menu-option-desc">${opt.desc}</div>\n        `,"undefined"!=typeof feather&&feather.replace(),optionEl.addEventListener("mouseenter",()=>{createUISound("hover")}),optionEl.addEventListener("click",()=>{opt.action();const gsap=window.gsap||window.GSAP;if(gsap){const blinkTimeline=gsap.timeline({onComplete:()=>{hidePartMenu()}});for(let i=0;i<3;i++)blinkTimeline.to(optionEl,{opacity:0,duration:.05,ease:"none"}).call(()=>createUISound("select")).to(optionEl,{opacity:1,duration:.05,ease:"none"})}else hidePartMenu()}),optionsContainer.appendChild(optionEl)}),closeBtn.onclick=()=>hidePartMenu(),backdrop.onclick=event=>{event.target===backdrop&&hidePartMenu()};const partContainerEl=document.getElementById("part-container"),uiButtons=[document.getElementById("music-player"),document.getElementById("fullscreen-button"),document.getElementById("rotate-button"),document.getElementById("info-button"),document.getElementById("book-button")];[partContainerEl,...uiButtons].filter(el=>null!==el).forEach(el=>{el.style.transition="none"}),overlay.classList.add("visible"),gsap.set(overlay,{opacity:1}),gsap.fromTo(backdrop,{opacity:0},{opacity:1,duration:.3,ease:"power2.out"}),gsap.set(container,{clipPath:"inset(0% 0% 100% 0%)",y:-50}),gsap.to(container,{clipPath:"inset(0% 0% 0% 0%)",y:0,duration:.25,ease:"circ.out"});const optionElements=optionsContainer.querySelectorAll(".part-menu-option");optionElements.forEach((el,index)=>{gsap.set(el,{opacity:0,y:-20}),gsap.to(el,{opacity:1,y:0,duration:.3,delay:0+.08*index,ease:"power1.out"});gsap.timeline({delay:0+.08*index}).set(el,{backgroundColor:"#ffd700"}).to(el,{duration:.1,backgroundColor:"rgba(255, 215, 0, 0.05)"})}),optionElements.forEach((el,index)=>{setTimeout(()=>{gsap.set(el,{clearProps:"backgroundColor"})},1e3*(0+.08*index+.4))})}function hidePartMenu(){const gsap=window.gsap||window.GSAP;if(!gsap)return;const overlay=document.getElementById("part-menu-overlay"),container=document.getElementById("part-menu-container"),backdrop=document.getElementById("part-menu-backdrop"),optionsContainer=document.getElementById("part-menu-options");if(!overlay||!container)return;const optionElements=optionsContainer.querySelectorAll(".part-menu-option");gsap.to(optionElements,{opacity:0,y:-10,duration:.2,stagger:.03,ease:"power2.in"}),gsap.to(container,{clipPath:"inset(0% 0% 100% 0%)",y:0,duration:.4,ease:"power2.in",onComplete:()=>{if(overlay.classList.remove("visible"),menuVisible=!1,document.body.classList.remove("menu-open"),clickedMesh&&clickedMeshOriginalMaterial&&(clickedMesh!==hoveredMesh&&(clickedMesh.material&&clickedMesh.material.dispose&&clickedMesh.material.dispose(),clickedMesh.material=clickedMeshOriginalMaterial.clone(),void 0!==clickedMesh.userData.originalCastShadow&&(clickedMesh.castShadow=clickedMesh.userData.originalCastShadow,clickedMesh.userData.originalCastShadow=void 0)),clickedMeshOriginalMaterial=null),clickedMesh=null,cameraOriginalState.saved){const camPos={x:camera.position.x,y:camera.position.y,z:camera.position.z},camTarget={x:controls.target.x,y:controls.target.y,z:controls.target.z};cameraFocusAnimation&&cameraFocusAnimation.kill(),gsap.to(camPos,{x:cameraOriginalState.position.x,y:cameraOriginalState.position.y,z:cameraOriginalState.position.z,duration:1,ease:"power2.inOut",onUpdate:()=>{camera.position.set(camPos.x,camPos.y,camPos.z),camera.updateProjectionMatrix()}}),gsap.to(camTarget,{x:cameraOriginalState.target.x,y:cameraOriginalState.target.y,z:cameraOriginalState.target.z,duration:1,ease:"power2.inOut",onUpdate:()=>{controls.target.set(camTarget.x,camTarget.y,camTarget.z),controls.update()},onComplete:()=>{cameraOriginalState.saved=!1,autoRotateEnabled=autoRotateStateBeforeMenu;const partContainerEl=document.getElementById("part-container"),uiButtons=[document.getElementById("music-player"),document.getElementById("fullscreen-button"),document.getElementById("rotate-button"),document.getElementById("info-button"),document.getElementById("book-button")];[partContainerEl,...uiButtons].filter(el=>null!==el).forEach(el=>{el.style.transition="none"}),partContainerEl&&infoPanelEnabled&&gsap.to(partContainerEl,{opacity:1,duration:.3,ease:"power2.out",overwrite:!0}),uiButtons.forEach(btn=>{btn&&gsap.to(btn,{opacity:1,duration:.3,ease:"power2.out",overwrite:!0})})}})}else{autoRotateEnabled=autoRotateStateBeforeMenu;const partContainerEl=document.getElementById("part-container"),uiButtons=[document.getElementById("music-player"),document.getElementById("fullscreen-button"),document.getElementById("rotate-button"),document.getElementById("info-button"),document.getElementById("book-button")];[partContainerEl,...uiButtons].filter(el=>null!==el).forEach(el=>{el.style.transition="none"}),partContainerEl&&infoPanelEnabled&&gsap.to(partContainerEl,{opacity:1,duration:.3,ease:"power2.out",overwrite:!0}),uiButtons.forEach(btn=>{btn&&gsap.to(btn,{opacity:1,duration:.3,ease:"power2.out",overwrite:!0})})}const resetContainer=document.getElementById("part-menu-container");menuFollowAnimation&&(menuFollowAnimation.kill(),menuFollowAnimation=null),resetContainer&&(resetContainer.style.transform="translate(-50%, -50%)"),menuMouseFollow.x=0,menuMouseFollow.y=0,menuMouseFollow.targetX=0,menuMouseFollow.targetY=0}}),gsap.to(backdrop,{opacity:0,duration:.3})}IS_MOBILE||window.addEventListener("mousedown",onMouseDown),IS_MOBILE||window.addEventListener("click",onMouseClick),window.addEventListener("keydown",event=>{"Escape"===event.key&&menuVisible&&hidePartMenu()});let porscheHistoryVisible=!1,outOfFundsVisible=!1,lightboxImages=[],currentLightboxIndex=0,lightboxNavigationHandlers=null;function showImageLightbox(mediaElement,imageIndex=null){window.showImageLightbox=showImageLightbox;const lightbox=document.getElementById("wiki-image-lightbox"),lightboxImage=document.getElementById("wiki-lightbox-image"),lightboxImageBg=document.getElementById("wiki-lightbox-image-bg"),lightboxCaption=document.getElementById("wiki-lightbox-caption"),lightboxVideo=document.getElementById("wiki-lightbox-video"),lightboxClose=document.getElementById("wiki-lightbox-close"),lightboxPrev=document.getElementById("wiki-lightbox-prev"),lightboxNext=document.getElementById("wiki-lightbox-next"),backdrop=document.getElementById("wiki-lightbox-backdrop");if(!lightbox||!lightboxImage||!lightboxVideo)return void console.log("Lightbox elements not found",{lightbox:lightbox,lightboxImage:lightboxImage,lightboxVideo:lightboxVideo});const content=document.getElementById("porsche-history-content");if(content){lightboxImages=[];Array.from(content.querySelectorAll(".porsche-history-image, .porsche-history-fullwidth-image")).forEach(block=>{const vid=block.querySelector("video"),img=block.querySelector("img");vid&&(vid.src||vid.currentSrc)?lightboxImages.push(vid.src||vid.currentSrc):img&&(img.src||img.currentSrc)&&lightboxImages.push(img.src||img.currentSrc)})}if(null!=imageIndex)currentLightboxIndex=imageIndex;else if(mediaElement){const clickedSrc=(mediaElement.src||mediaElement.currentSrc||"").replace(window.location.origin,"").replace(/^\/+/,"");currentLightboxIndex=lightboxImages.findIndex(src=>{const norm=(src||"").replace(window.location.origin,"").replace(/^\/+/,"");return norm===clickedSrc||norm.endsWith(clickedSrc)||clickedSrc.endsWith(norm)}),-1===currentLightboxIndex&&(currentLightboxIndex=0)}else currentLightboxIndex=0;(currentLightboxIndex<0||currentLightboxIndex>=lightboxImages.length)&&(currentLightboxIndex=0),lightboxVideo.pause(),lightboxVideo.style.display="none",lightboxImage.style.display="block";const originalSrc=lightboxImages[currentLightboxIndex];var src;function continueAfterSrcSet(imageSrc){const isNavigating=lightbox.classList.contains("visible")&&(lightboxImage.classList.contains("loaded")||lightboxVideo.classList.contains("loaded"));if(mediaElement&&mediaElement.alt)lightboxImage.alt=mediaElement.alt;else{const content=document.getElementById("porsche-history-content");if(content){const originalImg=Array.from(content.querySelectorAll(".porsche-history-image img, .porsche-history-fullwidth-image img")).find(img=>(img.src||img.currentSrc)===imageSrc);originalImg&&originalImg.alt?lightboxImage.alt=originalImg.alt:lightboxImage.alt=""}else lightboxImage.alt=""}if(lightboxCaption){let captionText="";if(content){const originalImg=Array.from(content.querySelectorAll(".porsche-history-image img, .porsche-history-fullwidth-image img")).find(img=>(img.src||img.currentSrc)===imageSrc);if(originalImg){const wrapper=originalImg.closest(".porsche-history-image-wrapper, .porsche-history-fullwidth-image");if(wrapper){const cap=wrapper.querySelector(".porsche-history-image-caption, .porsche-history-fullwidth-image-caption");cap&&(captionText=cap.textContent.trim())}}if(!captionText&&imageSrc.includes("ferdinand.jpg")){const ferdiCap=content.querySelector(".porsche-history-fullwidth-image-caption");ferdiCap&&(captionText=ferdiCap.textContent.trim())}}captionText||(captionText=lightboxImage.alt||""),lightboxCaption.textContent=captionText,lightboxCaption.classList.remove("loaded"),isNavigating?(lightboxCaption.style.opacity="0.6",lightboxCaption.style.filter="blur(6px)",lightboxCaption.style.transform="translateY(6px)"):(lightboxCaption.style.opacity="0",lightboxCaption.style.filter="blur(6px)",lightboxCaption.style.transform="translateY(6px)")}isNavigating?(lightboxImage.style.filter="blur(8px)",lightboxImage.style.transform="scale(0.98)",lightboxImage.style.opacity="1",lightboxImageBg&&(lightboxImageBg.classList.add("loaded"),lightboxImageBg.style.opacity="")):(lightboxImage.classList.remove("loaded"),lightboxImage.style.filter="blur(20px)",lightboxImage.style.transform="scale(0.9)",lightboxImage.style.opacity="0",lightboxImageBg&&(lightboxImageBg.classList.remove("loaded"),lightboxImageBg.style.opacity=""));const animateImage=()=>{isNavigating?(lightboxImage.classList.remove("loaded"),lightboxImage.style.filter="blur(5px)",lightboxImage.style.transform="scale(0.99)",lightboxImage.style.opacity="1",lightboxImage.offsetHeight,setTimeout(()=>{lightboxImage.classList.add("loaded"),setTimeout(()=>{lightboxImage.style.filter="",lightboxImage.style.transform="",lightboxImage.style.opacity=""},10)},50),lightboxImageBg&&(lightboxImageBg.classList.add("loaded"),lightboxImageBg.style.opacity=""),lightboxCaption&&(lightboxCaption.offsetHeight,setTimeout(()=>{lightboxCaption.classList.add("loaded"),setTimeout(()=>{lightboxCaption.style.opacity="",lightboxCaption.style.filter="",lightboxCaption.style.transform=""},10)},50))):(lightboxImage.classList.remove("loaded"),lightboxImage.style.filter="blur(20px)",lightboxImage.style.transform="scale(0.9)",lightboxImage.style.opacity="0",lightboxImage.offsetHeight,setTimeout(()=>{lightboxImage.classList.add("loaded"),setTimeout(()=>{lightboxImage.style.filter="",lightboxImage.style.transform="",lightboxImage.style.opacity=""},10)},50),lightboxImageBg&&(lightboxImageBg.classList.remove("loaded"),lightboxImageBg.style.opacity="0",lightboxImageBg.offsetHeight,setTimeout(()=>{lightboxImageBg.style.opacity="",lightboxImageBg.offsetHeight,requestAnimationFrame(()=>{lightboxImageBg.classList.add("loaded")})},50)),lightboxCaption&&(lightboxCaption.offsetHeight,setTimeout(()=>{lightboxCaption.classList.add("loaded"),setTimeout(()=>{lightboxCaption.style.opacity="",lightboxCaption.style.filter="",lightboxCaption.style.transform=""},10)},50)))},handleImageLoad=()=>{isNavigating?setTimeout(animateImage,50):setTimeout(animateImage,100)};if(lightboxImage.complete&&lightboxImage.naturalWidth>0)handleImageLoad();else{let imageLoaded=!1,bgLoaded=!1;const checkBothLoaded=()=>{imageLoaded&&bgLoaded&&handleImageLoad()};lightboxImage.addEventListener("load",()=>{imageLoaded=!0,checkBothLoaded()},{once:!0}),lightboxImageBg?lightboxImageBg.complete&&lightboxImageBg.naturalWidth>0?(bgLoaded=!0,checkBothLoaded()):lightboxImageBg.addEventListener("load",()=>{bgLoaded=!0,checkBothLoaded()},{once:!0}):(bgLoaded=!0,checkBothLoaded()),setTimeout(()=>{lightboxImage.complete&&!lightboxImage.classList.contains("loaded")&&(imageLoaded=!0),lightboxImageBg&&lightboxImageBg.complete&&(bgLoaded=!0),imageLoaded&&bgLoaded&&!lightboxImage.classList.contains("loaded")&&animateImage()},500)}lightbox.classList.add("visible"),lightboxPrev&&lightboxNext&&(lightboxPrev.disabled=!1,lightboxNext.disabled=!1);const cursorCross=document.getElementById("cursor-cross");cursorCross&&(cursorCross.style.zIndex="10003"),lightboxNavigationHandlers||(lightboxNavigationHandlers={navigateLightbox:direction=>{console.log("Navigate lightbox:",direction,"current index:",currentLightboxIndex,"total images:",lightboxImages.length),"prev"===direction?(0===currentLightboxIndex?currentLightboxIndex=lightboxImages.length-1:currentLightboxIndex--,showImageLightbox(null,currentLightboxIndex)):"next"===direction&&(currentLightboxIndex===lightboxImages.length-1?currentLightboxIndex=0:currentLightboxIndex++,showImageLightbox(null,currentLightboxIndex))},closeLightbox:()=>{lightbox.classList.add("closing"),setTimeout(()=>{lightbox.classList.remove("visible","closing"),lightboxVideo&&lightboxVideo.pause();const cursorCross=document.getElementById("cursor-cross");cursorCross&&(cursorCross.style.zIndex="10001"),window.removeEventListener("keydown",lightboxNavigationHandlers.handleLightboxKeyboard),lightboxImages=[],currentLightboxIndex=0},200)},handleLightboxKeyboard:e=>{const lightbox=document.getElementById("wiki-image-lightbox");lightbox&&lightbox.classList.contains("visible")&&("ArrowLeft"===e.key?(e.preventDefault(),lightboxNavigationHandlers.navigateLightbox("prev")):"ArrowRight"===e.key&&(e.preventDefault(),lightboxNavigationHandlers.navigateLightbox("next")))}});const newCloseBtn=lightboxClose.cloneNode(!0);lightboxClose.parentNode.replaceChild(newCloseBtn,lightboxClose);const newBackdrop=backdrop.cloneNode(!0);backdrop.parentNode.replaceChild(newBackdrop,backdrop);const newPrevBtn=lightboxPrev.cloneNode(!0);lightboxPrev.parentNode.replaceChild(newPrevBtn,lightboxPrev);const newNextBtn=lightboxNext.cloneNode(!0);lightboxNext.parentNode.replaceChild(newNextBtn,lightboxNext),newCloseBtn.addEventListener("click",lightboxNavigationHandlers.closeLightbox),newBackdrop.addEventListener("click",lightboxNavigationHandlers.closeLightbox),newPrevBtn.addEventListener("click",e=>{e.stopPropagation(),lightboxNavigationHandlers.navigateLightbox("prev")}),newNextBtn.addEventListener("click",e=>{e.stopPropagation(),lightboxNavigationHandlers.navigateLightbox("next")}),window.removeEventListener("keydown",lightboxNavigationHandlers.handleLightboxKeyboard),window.addEventListener("keydown",lightboxNavigationHandlers.handleLightboxKeyboard)}/\.(mp4|webm|mov)$/i.test(originalSrc)||/pfuture-video/i.test(originalSrc)?(lightboxImage.style.display="none",lightboxImageBg&&(lightboxImageBg.style.display="none",lightboxImageBg.src=""),lightboxVideo.style.display="block",lightboxVideo.src=originalSrc,lightboxVideo.muted=!0,lightboxVideo.loop=!0,lightboxVideo.playsInline=!0,lightboxVideo.style.width="",lightboxVideo.style.height="",lightboxVideo.style.filter="",lightboxVideo.style.transform="",lightboxVideo.style.clipPath="",lightboxVideo.addEventListener("loadeddata",()=>{try{lightboxVideo.play()}catch(e){}},{once:!0}),continueAfterSrcSet(originalSrc)):(src=originalSrc,new Promise(resolve=>{if(!src)return resolve(src);if(!src.toLowerCase().endsWith(".png"))return resolve(src);const jpgSrc=src.replace(/\.png$/i,".jpg"),testImg=new Image;testImg.onload=()=>resolve(jpgSrc),testImg.onerror=()=>resolve(src),testImg.src=jpgSrc})).then(finalSrc=>{lightboxImage.src=finalSrc,lightboxImageBg&&(lightboxImageBg.src=finalSrc,lightboxImageBg.style.display="block"),continueAfterSrcSet(finalSrc)})}function showPorscheHistory(){const gsap=window.gsap||window.GSAP,overlay=document.getElementById("porsche-history-overlay"),container=document.getElementById("porsche-history-container"),content=document.getElementById("porsche-history-content"),backdrop=document.getElementById("porsche-history-backdrop"),closeBtn=document.getElementById("porsche-history-close");if(!overlay||!container||!content)return void console.warn("Porsche history elements not found",{overlay:overlay,container:container,content:content});const scrollbar=document.getElementById("porsche-history-scrollbar");scrollbar&&(scrollbar.style.display="none"),porscheHistoryContainerReady=!1,console.log("Showing Porsche history popup");content.innerHTML='\n        <p><em>A Retrospective from 2060</em></p>\n        \n        <p>When we look back at the early 21st century, few automotive names carry the mythic weight that <strong>Porsche</strong> does. Long before vehicles became fully autonomous, connected, and post-combustion by default, Porsche represented something deeply human — the obsession with control, sensation, and sound.</p>\n        \n        <p>The cars weren\'t just machines. <strong>They were extensions of identity.</strong></p>\n        \n        <div class="porsche-history-fullwidth-image">\n            <video src="Media/ferdinand-animated.MP4" autoplay loop muted playsinline></video>\n            <div class="porsche-history-fullwidth-image-caption">Ferdinand Porsche (1875–1951) — engineer, innovator, and founder of Porsche.</div>\n        </div>\n        \n        <h3>The Age of the Driver (1930–2030)</h3>\n        \n        <p>Founded in 1931 by <strong>Ferdinand Porsche</strong>, the brand emerged from the same industrial fire that defined Europe between wars. The company\'s first masterpiece — the <strong>Volkswagen Beetle</strong> — wasn\'t even a Porsche model, but it established the lineage: simplicity, efficiency, and form following function.</p>\n        \n        <p>After World War II, Ferdinand\'s son <strong>Ferry Porsche</strong> decided to build something personal — a car for people who loved to drive, not just to move. The result was the <strong>Porsche 356 (1948)</strong>, a small, curved body of aluminum and spirit. It was light, quick, and soulful — and it marked the beginning of the Porsche legacy.</p>\n        \n        <p>But the myth didn\'t crystallize until 1964, when the <strong>Porsche 911</strong> appeared.</p>\n        \n        <p>The <strong>911</strong> was an anomaly: rear-engine, perfectly imperfect, but alive in the hands of those who understood it. Over the next century, it became one of humanity\'s longest-running design languages — a silhouette instantly recognizable even from orbiting colonies.</p>\n        \n        <div class="porsche-history-image-wrapper">\n            <div class="porsche-history-image"><img src="Media/p964.jpg" alt="Porsche 964" loading="lazy" decoding="async"></div>\n            <div class="porsche-history-image-caption">Porsche 964</div>\n        </div>\n        \n        <h3>Mechanical Religion</h3>\n        \n        <p>During the 20th and early 21st centuries, <strong>Porsche culture was almost spiritual.</strong> Owners gathered for early-morning drives through winding roads, chasing the sound of a flat-six engine echoing through forests or city tunnels.</p>\n        \n        <p>The <strong>911</strong> wasn\'t just a car; <strong>it was a ritual</strong> — a blend of engineering discipline and emotional release. Enthusiasts spoke of steering feedback, gear ratios, and throttle response with the reverence of monks describing sacred texts.</p>\n        \n        <div class="porsche-history-image-wrapper">\n            <div class="porsche-history-image"><img src="Media/p930.jpg" alt="Porsche 930 Turbo" loading="lazy" decoding="async"></div>\n            <div class="porsche-history-image-caption">Porsche 930 Turbo</div>\n        </div>\n        \n        <p>When electric cars began to take over in the 2020s, Porsche faced a crisis of identity. Many wondered: <strong>Could a silent Porsche still feel like a Porsche?</strong></p>\n        \n        <p>The answer arrived in 2019 with the <strong>Taycan</strong> — the company\'s first fully electric sports sedan. It was silent, but powerful; efficient, yet emotional. The Taycan\'s instant torque and precise steering reassured a generation that performance and sustainability could coexist. It became a transitional relic — the last breath of the combustion era meeting the first light of the electric age.</p>\n        \n        <h3>Cultural Symbolism</h3>\n        \n        <p>In the mid-century years, <strong>Porsche became shorthand for attainable perfection.</strong> Its slogan — <strong>"There is no substitute"</strong> — evolved into a cultural mantra representing mastery, focus, and emotional precision.</p>\n        \n        <p>The brand\'s design philosophy — clean, minimal, and purpose-driven — influenced not only car aesthetics but also architecture, industrial design, and digital interfaces. The timeless <strong>911 silhouette</strong> inspired furniture, fashion, and even the casings of AI robots in the 2060s.</p>\n        \n        <div class="porsche-history-image-wrapper">\n            <div class="porsche-history-image"><img src="Media/p918.jpg" alt="Porsche 918 Spyder" loading="lazy" decoding="async"></div>\n            <div class="porsche-history-image-caption">Porsche 918 Spyder</div>\n        </div>\n        \n        <p>Collectors treated early <strong>911s</strong>, <strong>918 Spyders</strong>, and <strong>992-series Taycans</strong> as sacred artifacts, preserving them in climate-controlled capsules long after gasoline was banned on most continents.</p>\n        \n        <h3>Racing and Legacy</h3>\n        \n        <p>Few brands blurred the line between the road and the racetrack like Porsche. Throughout the 20th and 21st centuries, it dominated endurance racing, especially the <strong>24 Hours of Le Mans</strong>, where it holds the record for most victories.</p>\n        \n        <div class="porsche-history-image-wrapper">\n            <div class="porsche-history-image"><img src="Media/plemans.jpg" alt="24 Hours of Le Mans" loading="lazy" decoding="async"></div>\n            <div class="porsche-history-image-caption">24 Hours of Le Mans</div>\n        </div>\n        \n        <p>In retrospect, those races were more than sport — they were engineering experiments in motion. Porsche\'s philosophy of <strong>"durability through precision"</strong> later influenced the mechanical design of early lunar rovers and orbital vehicles.</p>\n        \n        <h3>Post-Human Design (2030–2060)</h3>\n        \n        <p>As human driving faded from daily life, Porsche reinvented itself. By the 2040s, its vehicles had become <strong>augmented emotional machines</strong> — systems that combined human input with adaptive intelligence, tuned to mirror their driver\'s psychological state.</p>\n        \n        <div class="porsche-history-image-wrapper">\n            <div class="porsche-history-image"><video src="Media/pfuture-video.MP4" autoplay loop muted playsinline data-no-lightbox="true"></video></div>\n            <div class="porsche-history-image-caption">Porsche 9000</div>\n        </div>\n        \n        <p>Even as control shifted from hands to algorithms, Porsche remained faithful to one principle: <strong>a machine can still be felt.</strong></p>\n        \n        <p>The final analog <strong>911s</strong> built in 2045 were celebrated as <strong>"The Last True Porsches,"</strong> hand-assembled tributes to a disappearing era of raw connection.</p>\n        \n        <p>By the 2070s, Porsche\'s influence lived on not through cars, but through <strong>design language and philosophy</strong> — a foundation for modern mobility systems, from hovercrafts to interplanetary transports.</p>\n        \n        <h3>Conclusion — Why Porsche Still Matters</h3>\n        \n        <p><strong>Porsche was never just a car company.</strong> It was a mirror of humanity\'s relationship with motion. It taught us that speed wasn\'t about getting somewhere faster — <strong>it was about feeling alive while getting there.</strong></p>\n        \n        <p style="margin-bottom: 62px;">Even in 2060, when roads are memories and vehicles glide silently across air, the shape of a <strong>911</strong> remains a reminder of what driving once meant: <strong>a dance between man, machine, and the horizon.</strong></p>\n        \n        <div class="porsche-history-stock-chart-separator"></div>\n        \n        <div class="porsche-history-stock-chart">\n            <div class="porsche-history-stock-chart-title">Market Performance (2060)</div>\n            <canvas id="porsche-stock-chart" width="800" height="200"></canvas>\n            <div class="porsche-history-stock-chart-legend">\n                <div class="porsche-history-stock-chart-legend-item">\n                    <div class="porsche-history-stock-chart-legend-line"></div>\n                    <span>P911</span>\n                </div>\n                <div class="porsche-history-stock-chart-legend-item">\n                    <div class="porsche-history-stock-chart-legend-line sp500"></div>\n                    <span>SP500</span>\n                </div>\n            </div>\n        </div>\n        \n        <div class="porsche-history-buttons">\n            <div class="porsche-history-done-button">I\'M DONE READING</div>\n            <div class="porsche-history-buy-button">PURCHASE</div>\n        </div>\n    ',content.scrollTop=0;const doneButton=content.querySelector(".porsche-history-done-button"),buyButton=content.querySelector(".porsche-history-buy-button");doneButton&&(doneButton.classList.remove("visible"),doneButton.style.opacity="0",doneButton.style.transform="translateY(10px)"),buyButton&&(buyButton.classList.remove("visible"),buyButton.style.opacity="0",buyButton.style.transform="translateY(10px)");content.querySelectorAll("p").forEach(p=>{p.classList.remove("visible"),p.style.opacity="0",p.style.transform="translateY(20px)",p.style.clipPath="inset(0 100% 0 0)"});content.querySelectorAll(".porsche-history-image-placeholder").forEach(img=>{img.classList.remove("visible"),img.style.opacity="0",img.style.transform="translateY(10px)"});content.querySelectorAll(".porsche-history-image").forEach(container=>{container.classList.remove("visible"),container.style.opacity="0",container.style.transform="translateY(10px)"});content.querySelectorAll(".porsche-history-image-wrapper");content.querySelectorAll(".porsche-history-image-caption").forEach(caption=>{caption.classList.remove("visible"),caption.style.opacity="0",caption.style.transform="translateY(10px)"});content.querySelectorAll("h3").forEach(h=>{h.classList.remove("visible"),h.style.opacity="0",h.style.transform="translateY(20px)",h.style.clipPath="inset(0 100% 0 0)"});const partContainerEl=document.getElementById("part-container"),uiButtons=[document.getElementById("music-player"),document.getElementById("fullscreen-button"),document.getElementById("rotate-button"),document.getElementById("info-button"),document.getElementById("book-button")];[partContainerEl,...uiButtons].filter(el=>null!==el).forEach(el=>{el.style.transition="none"}),overlay.classList.add("visible"),gsap.set(overlay,{opacity:1}),gsap.fromTo(backdrop,{opacity:0},{opacity:1,duration:.3,ease:"power2.out"}),porscheHistoryMouseFollow.x=0,porscheHistoryMouseFollow.y=0,porscheHistoryMouseFollow.targetX=0,porscheHistoryMouseFollow.targetY=0;const title=document.getElementById("porsche-history-title");title&&gsap&&gsap.to(title,{opacity:1,y:0,clipPath:"inset(0 0% 0 0)",duration:.8,ease:"expo.inOut"}),gsap.set(container,{clipPath:"inset(0% 0% 100% 0%)",y:-50}),gsap.to(container,{clipPath:"inset(0% 0% 0% 0%)",y:0,duration:.25,ease:"circ.out",onUpdate:()=>{const gsapY=gsap.getProperty(container,"y")||0;container.style.transform=`translate(calc(-50% + ${porscheHistoryMouseFollow.x}px), calc(-50% + ${gsapY+porscheHistoryMouseFollow.y}px))`},onComplete:()=>{porscheHistoryContainerReady=!0,initPorscheHistoryScrollReveal()}}),porscheHistoryVisible=!0,document.body.classList.add("menu-open");const handleWheel=e=>{porscheHistoryVisible&&content&&(e.preventDefault(),e.stopPropagation(),content.scrollTop+=e.deltaY,content.dispatchEvent(new Event("scroll")))};window.addEventListener("wheel",handleWheel,{passive:!1,capture:!0}),window._porscheHistoryWheelHandler=handleWheel,closeBtn&&(closeBtn.onclick=()=>hidePorscheHistory()),backdrop&&(backdrop.onclick=event=>{event.target===backdrop&&hidePorscheHistory()})}let stockChartAnimationFrame=null;function initStockChart(){const canvas=document.getElementById("porsche-stock-chart"),chartTitle=document.querySelector(".porsche-history-stock-chart-title"),chartLegend=document.querySelector(".porsche-history-stock-chart-legend");if(!canvas||!chartTitle)return;const ctx=canvas.getContext("2d"),container=canvas.parentElement;if(container){const rect=container.getBoundingClientRect();canvas.width=rect.width,canvas.height=Math.round(rect.width*(9/16))}const width=canvas.width,height=canvas.height,padding_top=20,padding_right=20,padding_bottom=30,padding_left=40,chartWidth=width-padding_left-padding_right,chartHeight=height-padding_top-padding_bottom,years=[],porscheData=[],sp500Data=[];let porschePrice=82.5,sp500Base=100;const crashPeriods=[{year:2029,severity:.35},{year:2037,severity:.22},{year:2043,severity:.28},{year:2051,severity:.19},{year:2062,severity:.25},{year:2070,severity:.15}];for(let year=2022;year<=2060;year++){years.push(year);const crash=crashPeriods.find(c=>c.year===year||c.year===year-1||c.year===year+1),isCrashYear=crash&&(year===crash.year||year===crash.year+1);let volatility=.12*(Math.random()-.5),trend=year<2030?.1:year<2045?.08:.06;if(isCrashYear&&crash){porschePrice*=1-crash.severity*(.6+.4*Math.random())}else if(2031!==year&&2038!==year||!isCrashYear)porschePrice*=1+trend+volatility;else{porschePrice*=1+(.1+.08*Math.random())}Math.random()<.1&&!isCrashYear&&(porschePrice*=.94+.04*Math.random()),porschePrice=Math.max(.93*porschePrice,1.18*porschePrice),porscheData.push(Math.round(100*porschePrice)/100);let spVolatility=.05*(Math.random()-.5),spTrend=year<2030?.06:year<2045?.04:.03;if(isCrashYear&&crash&&crash.severity>.28){sp500Base*=1-.25*crash.severity*(.7+.3*Math.random())}else if(2031===year||2038===year&&crash&&crash.severity>.28){sp500Base*=1+(.05+.04*Math.random())}else sp500Base*=1+spTrend+spVolatility;sp500Base=Math.max(.97*sp500Base,1.13*sp500Base),sp500Data.push(Math.round(100*sp500Base)/100)}const displayYears=years.filter((_,i)=>i%5==0||i===years.length-1),maxPorsche=Math.max(...porscheData),minPorsche=Math.min(...porscheData),maxSp500=Math.max(...sp500Data),minSp500=Math.min(...sp500Data),porscheRange=maxPorsche-minPorsche,sp500Range=maxSp500-minSp500;let animationProgress=0;let isAnimating=!0;function drawChart(){if(!isAnimating&&animationProgress>=1)return;ctx.clearRect(0,0,width,height),ctx.strokeStyle="rgba(255, 215, 0, 0.15)",ctx.lineWidth=1;for(let i=0;i<=10;i++){const y=padding_top+chartHeight/10*i;ctx.beginPath(),ctx.moveTo(padding_left,y),ctx.lineTo(width-padding_right,y),ctx.stroke()}for(let i=0;i<displayYears.length;i++){const yearIndex=years.indexOf(displayYears[i]),x=padding_left+chartWidth/(years.length-1)*yearIndex;ctx.beginPath(),ctx.moveTo(x,padding_top),ctx.lineTo(x,height-padding_bottom),ctx.stroke()}const totalPoints=years.length;var t;const currentPoint=((t=animationProgress)<.5?2*t*t:1-Math.pow(-2*t+2,3)/2)*totalPoints,pointsToDraw=Math.floor(currentPoint),partialProgress=currentPoint-pointsToDraw;if(pointsToDraw>=1){ctx.strokeStyle="rgba(255, 215, 0, 0.5)",ctx.lineWidth=1.5,ctx.setLineDash([6,4]),ctx.beginPath();for(let i=0;i<pointsToDraw;i++){const x=padding_left+chartWidth/(years.length-1)*i,normalizedValue=(sp500Data[i]-minSp500)/sp500Range,y=padding_top+chartHeight-normalizedValue*chartHeight;0===i?ctx.moveTo(x,y):ctx.lineTo(x,y)}if(pointsToDraw<totalPoints&&partialProgress>0){const x1=padding_left+chartWidth/(years.length-1)*pointsToDraw,normalizedValue1=(sp500Data[pointsToDraw]-minSp500)/sp500Range,y1=padding_top+chartHeight-normalizedValue1*chartHeight;if(0===pointsToDraw)ctx.moveTo(x1,y1);else{const prevX=padding_left+chartWidth/(years.length-1)*(pointsToDraw-1),prevNormValue=(sp500Data[pointsToDraw-1]-minSp500)/sp500Range,prevY=padding_top+chartHeight-prevNormValue*chartHeight,interpX=prevX+(x1-prevX)*partialProgress,interpY=prevY+(y1-prevY)*partialProgress;ctx.lineTo(interpX,interpY)}}ctx.stroke(),ctx.setLineDash([])}if(pointsToDraw>=1){ctx.shadowBlur=6,ctx.shadowColor="#00ff88",ctx.strokeStyle="#00ff88",ctx.lineWidth=2,ctx.beginPath();for(let i=0;i<pointsToDraw;i++){const x=padding_left+chartWidth/(years.length-1)*i,normalizedValue=(porscheData[i]-minPorsche)/porscheRange,y=padding_top+chartHeight-normalizedValue*chartHeight;0===i?ctx.moveTo(x,y):ctx.lineTo(x,y)}if(pointsToDraw<totalPoints&&partialProgress>0){const x1=padding_left+chartWidth/(years.length-1)*pointsToDraw,normalizedValue1=(porscheData[pointsToDraw]-minPorsche)/porscheRange,y1=padding_top+chartHeight-normalizedValue1*chartHeight;if(0===pointsToDraw)ctx.moveTo(x1,y1);else{const prevX=padding_left+chartWidth/(years.length-1)*(pointsToDraw-1),prevNormValue=(porscheData[pointsToDraw-1]-minPorsche)/porscheRange,prevY=padding_top+chartHeight-prevNormValue*chartHeight,interpX=prevX+(x1-prevX)*partialProgress,interpY=prevY+(y1-prevY)*partialProgress;ctx.lineTo(interpX,interpY)}}ctx.stroke();for(let i=0;i<pointsToDraw;i++)if(i%5==0||i===pointsToDraw-1){const x=padding_left+chartWidth/(years.length-1)*i,normalizedValue=(porscheData[i]-minPorsche)/porscheRange,y=padding_top+chartHeight-normalizedValue*chartHeight;ctx.shadowBlur=6,ctx.fillStyle="#00ff88",ctx.beginPath(),ctx.arc(x,y,3,0,2*Math.PI),ctx.fill()}ctx.shadowBlur=0}ctx.fillStyle="rgba(255, 215, 0, 0.6)",ctx.font="11px DM Mono",ctx.textAlign="center",ctx.textBaseline="top";for(let i=0;i<displayYears.length;i++){const yearIndex=years.indexOf(displayYears[i]),x=padding_left+chartWidth/(years.length-1)*yearIndex;ctx.fillText(displayYears[i].toString(),x,height-padding_bottom+8)}ctx.textAlign="right",ctx.textBaseline="middle";for(let i=0;i<=5;i++){const y=padding_top+chartHeight/5*(5-i),value=minPorsche+porscheRange/5*i;ctx.fillText(Math.round(value).toString(),padding_left-10,y)}animationProgress<1?(animationProgress+=.0167,animationProgress>1&&(animationProgress=1,isAnimating=!1),stockChartAnimationFrame=requestAnimationFrame(drawChart)):(isAnimating=!1,chartTitle&&!chartTitle.classList.contains("visible")&&chartTitle.classList.add("visible"),chartLegend&&!chartLegend.classList.contains("visible")&&chartLegend.classList.add("visible"),canvas&&!canvas.classList.contains("visible")&&canvas.classList.add("visible"))}canvas&&canvas.classList.add("visible"),animationProgress=0,isAnimating=!0,setTimeout(()=>{drawChart()},300)}let porscheHistoryScrollRevealActive=!1,porscheHistoryScrollRevealElements=null,porscheHistoryContainerReady=!1;function initPorscheHistoryScrollReveal(){porscheHistoryScrollRevealElements=null,porscheHistoryScrollRevealActive&&(porscheHistoryScrollRevealActive=!1);const content=document.getElementById("porsche-history-content");if(!content)return;const scrollbar=document.getElementById("porsche-history-scrollbar"),scrollbarThumb=document.getElementById("porsche-history-scrollbar-thumb"),container=document.getElementById("porsche-history-container");function updateScrollbar(){if(!porscheHistoryVisible)return void(scrollbar&&(scrollbar.style.display="none"));if(!(scrollbar&&scrollbarThumb&&container&&content))return;if(!porscheHistoryContainerReady)return void(scrollbar&&(scrollbar.style.display="none"));const scrollHeight=content.scrollHeight,clientHeight=content.clientHeight,scrollTop=content.scrollTop;if(scrollHeight<=clientHeight)return void(scrollbar.style.display="none");const containerRect=container.getBoundingClientRect();scrollbar.style.left=`${containerRect.right+4}px`,scrollbar.style.top=`${containerRect.top}px`,scrollbar.style.height=`${containerRect.height}px`,scrollbar.style.display="block";const thumbHeight=clientHeight/scrollHeight*scrollbar.clientHeight;scrollbarThumb.style.height=`${thumbHeight}px`;const maxScrollTop=scrollHeight-clientHeight,thumbTop=maxScrollTop>0?scrollTop/maxScrollTop*(scrollbar.clientHeight-thumbHeight):0;scrollbarThumb.style.top=`${thumbTop}px`}window.addEventListener("resize",updateScrollbar),content.addEventListener("scroll",updateScrollbar);const handleFullWidthParallax=()=>{if(!porscheHistoryVisible)return;const scrollTop=content.scrollTop;content.querySelectorAll(".porsche-history-fullwidth-image img, .porsche-history-fullwidth-image video").forEach(media=>{const mediaContainer=media.parentElement;if(!mediaContainer)return;const containerRect=mediaContainer.getBoundingClientRect(),contentRect=content.getBoundingClientRect(),mediaTop=containerRect.top-contentRect.top+scrollTop,mediaBottom=mediaTop+containerRect.height;if(scrollTop>=mediaTop-content.clientHeight&&scrollTop<=mediaBottom+content.clientHeight){if((window.getComputedStyle(media).clipPath||"").includes("100%"))return;const mediaOffset=(scrollTop-mediaTop)*.3;media.style.transform=`translateY(${mediaOffset}px)`}})};content.addEventListener("scroll",handleFullWidthParallax),setTimeout(()=>{handleFullWidthParallax()},100),content.addEventListener("click",e=>{const target=e.target;if("IMG"===target.tagName&&(target.closest(".porsche-history-image")||target.closest(".porsche-history-fullwidth-image")))e.stopPropagation(),e.preventDefault(),console.log("Image clicked:",target.src||target.currentSrc),target.style.cursor="pointer",showImageLightbox(target);else if("VIDEO"===target.tagName||target.closest(".porsche-history-image")?.querySelector("video")){const videoEl="VIDEO"===target.tagName?target:target.closest(".porsche-history-image")?.querySelector("video");if(!videoEl)return;e.stopPropagation(),e.preventDefault(),showImageLightbox(videoEl)}});let isDragging=!1,startY=0,startScrollTop=0;scrollbarThumb.addEventListener("mousedown",e=>{isDragging=!0,startY=e.clientY,startScrollTop=content.scrollTop,e.preventDefault()}),document.addEventListener("mousemove",e=>{if(!isDragging)return;const deltaY=e.clientY-startY,scrollbarHeight=scrollbar.clientHeight,thumbHeight=parseFloat(scrollbarThumb.style.height)||0,maxScrollTop=content.scrollHeight-content.clientHeight,scrollRatio=deltaY/(scrollbarHeight-thumbHeight),newScrollTop=Math.max(0,Math.min(maxScrollTop,startScrollTop+scrollRatio*maxScrollTop));content.scrollTop=newScrollTop}),document.addEventListener("mouseup",()=>{isDragging=!1}),scrollbar.addEventListener("click",e=>{if(e.target===scrollbarThumb)return;const clickY=e.clientY-scrollbar.getBoundingClientRect().top,scrollbarHeight=scrollbar.clientHeight,newScrollTop=(parseFloat(scrollbarThumb.style.height),clickY/scrollbarHeight*(content.scrollHeight-content.clientHeight));content.scrollTop=newScrollTop}),setTimeout(()=>{updateScrollbar()},300);let stockChartInitialized=!1;porscheHistoryScrollRevealActive=!0;const paragraphs=Array.from(content.querySelectorAll("p")),headings=Array.from(content.querySelectorAll("h3")),imagePlaceholders=Array.from(content.querySelectorAll(".porsche-history-image-placeholder")),images=Array.from(content.querySelectorAll(".porsche-history-image")),fullWidthImages=Array.from(content.querySelectorAll(".porsche-history-fullwidth-image")),imageCaptions=Array.from(content.querySelectorAll(".porsche-history-image-caption")),stockChart=content.querySelector(".porsche-history-stock-chart"),allElements=[...paragraphs,...headings,...imagePlaceholders,...images,...fullWidthImages,...imageCaptions];stockChart&&allElements.push(stockChart);let revealedElements=new Set;function revealOnScroll(){porscheHistoryVisible&&allElements.forEach((el,index)=>{if(revealedElements.has(el))return;const rect=el.getBoundingClientRect(),contentRect=content.getBoundingClientRect();if(rect.top-contentRect.top<content.clientHeight-150){if(revealedElements.add(el),el.classList.contains("porsche-history-stock-chart")&&!stockChartInitialized){stockChartInitialized=!0;const chartTitle=el.querySelector(".porsche-history-stock-chart-title"),chartLegend=el.querySelector(".porsche-history-stock-chart-legend");chartTitle&&chartTitle.classList.add("visible"),chartLegend&&chartLegend.classList.add("visible"),initStockChart()}if(el.classList.contains("porsche-history-image")){let placeholderBlock=el.querySelector(".porsche-history-image-placeholder-block");placeholderBlock||(placeholderBlock=document.createElement("div"),placeholderBlock.className="porsche-history-image-placeholder-block",el.insertBefore(placeholderBlock,el.firstChild));const media=el.querySelector("img")||el.querySelector("video");el.style.opacity="1",el.style.transform="translateY(0)",media&&(media.style.clipPath="inset(0 100% 0 0)"),placeholderBlock.style.clipPath="inset(0 100% 0 0)";const gsap=window.gsap||window.GSAP;gsap?(gsap.to(placeholderBlock,{clipPath:"inset(0 0% 0 0)",duration:.8,ease:"power2.out"}),setTimeout(()=>{el.classList.add("visible"),media&&gsap.to(media,{clipPath:"inset(0 0% 0 0)",duration:.8,ease:"power2.out",onComplete:()=>{gsap.to(placeholderBlock,{opacity:0,duration:.3,ease:"power2.out"})}})},200)):setTimeout(()=>{placeholderBlock.style.clipPath="inset(0 0% 0 0)",setTimeout(()=>{el.classList.add("visible"),media&&(media.style.clipPath="inset(0 0% 0 0)",setTimeout(()=>{placeholderBlock.style.opacity="0"},800))},200)},50);const wrapper=el.parentElement,caption=wrapper?wrapper.querySelector(".porsche-history-image-caption"):null;if(caption){revealedElements.add(caption);const gsap=window.gsap||window.GSAP;gsap?(gsap.set(caption,{opacity:0,y:10,filter:"blur(6px)",clipPath:"inset(0 100% 0 0)"}),caption.classList.add("visible"),gsap.to(caption,{opacity:1,y:0,filter:"blur(0px)",clipPath:"inset(0 0% 0 0)",duration:.8,ease:"power2.out"})):(caption.style.opacity="1",caption.style.transform="translateY(0)",caption.style.filter="blur(0px)",caption.style.clipPath="inset(0 0% 0 0)")}}else if(el.classList.contains("porsche-history-fullwidth-image")){const media=el.querySelector("img")||el.querySelector("video");if(!media)return;let placeholderBlock=el.querySelector(".porsche-history-fullwidth-image-placeholder-block");placeholderBlock||(placeholderBlock=document.createElement("div"),placeholderBlock.className="porsche-history-fullwidth-image-placeholder-block",el.insertBefore(placeholderBlock,el.firstChild));const caption=el.querySelector(".porsche-history-fullwidth-image-caption");media.style.opacity="1",media.style.clipPath="inset(0 100% 0 0)",placeholderBlock.style.clipPath="inset(0 100% 0 0)",caption&&(revealedElements.add(caption),caption.style.opacity="0",caption.style.transform="translateY(10px)",caption.style.filter="blur(6px)",caption.style.clipPath="inset(0 100% 0 0)");const gsap=window.gsap||window.GSAP,checkMediaLoadAndReveal=()=>{gsap?(gsap.to(placeholderBlock,{clipPath:"inset(0 0% 0 0)",duration:.8,ease:"power2.out"}),setTimeout(()=>{gsap.to(media,{clipPath:"inset(0 0% 0 0)",duration:.8,ease:"power2.out",onComplete:()=>{gsap.to(placeholderBlock,{opacity:0,duration:.3,ease:"power2.out"})}})},200)):setTimeout(()=>{placeholderBlock.style.clipPath="inset(0 0% 0 0)",setTimeout(()=>{media.style.clipPath="inset(0 0% 0 0)","IMG"===media.tagName&&media.complete&&0!==media.naturalHeight||"VIDEO"===media.tagName&&media.readyState>=2?revealFullWidthCaption(caption,null):"IMG"===media.tagName?media.addEventListener("load",()=>{revealFullWidthCaption(caption,null)},{once:!0}):"VIDEO"===media.tagName&&media.addEventListener("loadeddata",()=>{revealFullWidthCaption(caption,null)},{once:!0})},200)},50)},revealFullWidthCaption=(cap,gsapLib)=>{cap&&(cap.classList.add("visible"),gsapLib?gsapLib.to(cap,{opacity:1,y:0,filter:"blur(0px)",clipPath:"inset(0 0% 0 0)",duration:.8,ease:"power2.out"}):(cap.style.opacity="1",cap.style.transform="translateY(0)",cap.style.filter="blur(0px)",cap.style.clipPath="inset(0 0% 0 0)"))};checkMediaLoadAndReveal()}else if("P"===el.tagName||"H3"===el.tagName){el.style.opacity="0",el.style.transform="translateY(20px)",el.style.clipPath="inset(0 100% 0 0)",el.classList.add("visible");const gsap=window.gsap||window.GSAP;gsap?gsap.to(el,{opacity:1,y:0,clipPath:"inset(0 0% 0 0)",duration:1,ease:"power2.out"}):setTimeout(()=>{el.style.opacity="1",el.style.transform="translateY(0)",el.style.clipPath="inset(0 0% 0 0)"},50)}else{if(el.classList.contains("porsche-history-image-caption")){const wrapper=el.parentElement,image=wrapper?wrapper.querySelector(".porsche-history-image"):null;if(image&&revealedElements.has(image)){revealedElements.add(el),el.style.opacity="0",el.style.transform="translateY(10px)",el.style.clipPath="inset(0 100% 0 0)",el.classList.add("visible");const gsap=window.gsap||window.GSAP;gsap?gsap.to(el,{opacity:1,y:0,clipPath:"inset(0 0% 0 0)",duration:.8,ease:"power2.out"}):setTimeout(()=>{el.style.opacity="1",el.style.transform="translateY(0)",el.style.clipPath="inset(0 0% 0 0)"},50)}else if(!image){revealedElements.add(el),el.style.opacity="0",el.style.transform="translateY(10px)",el.style.clipPath="inset(0 100% 0 0)",el.classList.add("visible");const gsap=window.gsap||window.GSAP;gsap?gsap.to(el,{opacity:1,y:0,clipPath:"inset(0 0% 0 0)",duration:.8,ease:"power2.out"}):setTimeout(()=>{el.style.opacity="1",el.style.transform="translateY(0)",el.style.clipPath="inset(0 0% 0 0)"},50)}return}{el.style.opacity="0",el.style.transform="translateY(10px)",el.classList.add("visible");const gsap=window.gsap||window.GSAP;gsap?gsap.to(el,{opacity:1,y:0,duration:.6,ease:"power2.out"}):setTimeout(()=>{el.style.opacity="1",el.style.transform="translateY(0)"},50)}}}})}porscheHistoryScrollRevealElements=revealedElements,allElements.length>0&&setTimeout(()=>{allElements.slice(0,Math.min(2,allElements.length)).forEach((el,idx)=>{if(revealedElements.add(el),el.classList.contains("porsche-history-image")){el.style.opacity="0",el.style.transform="translateY(10px)",el.style.clipPath="inset(0 100% 0 0)",el.classList.add("visible");const gsap=window.gsap||window.GSAP;gsap?gsap.to(el,{opacity:1,y:0,clipPath:"inset(0 0% 0 0)",duration:.8,delay:.1*idx,ease:"power2.out"}):setTimeout(()=>{el.style.opacity="1",el.style.transform="translateY(0)",el.style.clipPath="inset(0 0% 0 0)"},100*idx);const wrapper=el.parentElement,caption=wrapper?wrapper.querySelector(".porsche-history-image-caption"):null;if(caption){revealedElements.add(caption);const gsap=window.gsap||window.GSAP;if(gsap){gsap.set(caption,{opacity:0,y:10,clipPath:"inset(0 100% 0 0)"}),caption.classList.add("visible");setTimeout(()=>{gsap.to(caption,{opacity:1,y:0,clipPath:"inset(0 0% 0 0)",duration:.8,ease:"power2.out"})},800+1e3*(.1*idx))}else setTimeout(()=>{caption.style.opacity="1",caption.style.transform="translateY(0)",caption.style.clipPath="inset(0 0% 0 0)"},800)}}else{if(el.classList.contains("porsche-history-image-caption"))return;{el.style.opacity="0",el.style.transform="translateY(10px)",el.classList.add("visible");const gsap=window.gsap||window.GSAP;gsap?gsap.to(el,{opacity:1,y:0,duration:.6,delay:.1*idx,ease:"power2.out"}):setTimeout(()=>{el.style.opacity="1",el.style.transform="translateY(0)"},100*idx)}}})},200);const doneButton=content.querySelector(".porsche-history-done-button"),buyButton=content.querySelector(".porsche-history-buy-button");function checkDoneButton(){if(!doneButton)return;const scrollTop=content.scrollTop;if(content.scrollHeight-scrollTop-content.clientHeight<200){if(doneButton&&!doneButton.classList.contains("visible")){doneButton.classList.add("visible");const gsap=window.gsap||window.GSAP;gsap&&gsap.to(doneButton,{opacity:1,y:0,duration:.6,ease:"power2.out"})}if(buyButton&&!buyButton.classList.contains("visible")){buyButton.classList.add("visible");const gsap=window.gsap||window.GSAP;gsap&&gsap.to(buyButton,{opacity:1,y:0,duration:.6,delay:.1,ease:"power2.out"})}}}doneButton&&(doneButton.addEventListener("click",()=>{hidePorscheHistory()}),doneButton.addEventListener("mouseenter",()=>{createUISound("hover")})),buyButton&&(buyButton.addEventListener("click",()=>{hidePorscheHistory(),setTimeout(()=>{showOutOfFundsPopup()},450)}),buyButton.addEventListener("mouseenter",()=>{createUISound("hover")}));content.addEventListener("scroll",()=>{revealOnScroll(),doneButton&&checkDoneButton()}),doneButton&&checkDoneButton(),setTimeout(()=>{revealOnScroll()},100)}function hidePorscheHistory(){const gsap=window.gsap||window.GSAP,overlay=document.getElementById("porsche-history-overlay"),container=document.getElementById("porsche-history-container"),backdrop=document.getElementById("porsche-history-backdrop");if(!overlay||!container)return;porscheHistoryScrollRevealActive=!1,porscheHistoryScrollRevealElements=null,porscheHistoryFollowAnimation&&(porscheHistoryFollowAnimation.kill(),porscheHistoryFollowAnimation=null),porscheHistoryMouseFollow.x=0,porscheHistoryMouseFollow.y=0,porscheHistoryMouseFollow.targetX=0,porscheHistoryMouseFollow.targetY=0;const content=document.getElementById("porsche-history-content");content&&(content.scrollTop=0);const title=document.getElementById("porsche-history-title");if(title&&(title.style.opacity="0",title.style.transform="translateY(10px)",title.style.clipPath="inset(0 100% 0 0)"),content){content.querySelectorAll("p, h3, .porsche-history-image-placeholder, .porsche-history-image-caption, .porsche-history-done-button, .porsche-history-buy-button").forEach(el=>{el.classList.remove("visible"),el.style.opacity="0",el.style.transform="translateY(10px)"});content.querySelectorAll(".porsche-history-image").forEach(container=>{container.classList.remove("visible"),container.style.opacity="0",container.style.transform="translateY(10px)"})}gsap.to([overlay,container],{opacity:0,duration:.2,ease:"power2.in",onComplete:()=>{overlay.classList.remove("visible"),window._porscheHistoryWheelHandler&&(window.removeEventListener("wheel",window._porscheHistoryWheelHandler,{capture:!0}),delete window._porscheHistoryWheelHandler),porscheHistoryVisible=!1,document.body.classList.remove("menu-open"),gsap.set([overlay,container],{opacity:1});const partContainerEl=document.getElementById("part-container"),uiButtons=[document.getElementById("music-player"),document.getElementById("fullscreen-button"),document.getElementById("rotate-button"),document.getElementById("info-button"),document.getElementById("book-button")];[partContainerEl,...uiButtons].filter(el=>null!==el).forEach(el=>{el.style.transition="none"}),partContainerEl&&infoPanelEnabled&&gsap.to(partContainerEl,{opacity:1,duration:.3,ease:"power2.out",overwrite:!0}),uiButtons.forEach(btn=>{btn&&gsap.to(btn,{opacity:1,duration:.3,ease:"power2.out",overwrite:!0})})}}),gsap.to(backdrop,{opacity:0,duration:.3}),console.log("Porsche history popup hidden")}function showOutOfFundsPopup(){const gsap=window.gsap||window.GSAP,overlay=document.getElementById("out-of-funds-overlay"),container=document.getElementById("out-of-funds-container"),backdrop=document.getElementById("out-of-funds-backdrop"),button=document.getElementById("out-of-funds-button");if(!overlay||!container)return void console.warn("Out of funds elements not found",{overlay:overlay,container:container});console.log("Showing Out of Funds popup");const partContainerEl=document.getElementById("part-container"),uiButtons=[document.getElementById("music-player"),document.getElementById("fullscreen-button"),document.getElementById("rotate-button"),document.getElementById("info-button"),document.getElementById("book-button")];[partContainerEl,...uiButtons].filter(el=>null!==el).forEach(el=>{el.style.transition="none"}),button&&(button.style.opacity="0",button.style.transform="translateY(20px)"),overlay.classList.add("visible"),gsap.set(overlay,{opacity:1}),gsap.fromTo(backdrop,{opacity:0},{opacity:1,duration:.3,ease:"power2.out"}),gsap.set(container,{clipPath:"inset(0% 0% 100% 0%)",y:-50}),gsap.to(container,{clipPath:"inset(0% 0% 0% 0%)",y:0,duration:.25,ease:"circ.out",onComplete:()=>{button&&(gsap.set(button,{opacity:0,y:-20}),gsap.to(button,{opacity:1,y:0,duration:.3,delay:0,ease:"power1.out"}))}}),outOfFundsVisible=!0,document.body.classList.add("menu-open"),button&&(button.onclick=()=>hideOutOfFundsPopup()),backdrop&&(backdrop.onclick=event=>{event.target===backdrop&&hideOutOfFundsPopup()})}function hideOutOfFundsPopup(){const gsap=window.gsap||window.GSAP,overlay=document.getElementById("out-of-funds-overlay"),container=document.getElementById("out-of-funds-container"),backdrop=document.getElementById("out-of-funds-backdrop");overlay&&container&&(gsap.to(container,{clipPath:"inset(0% 0% 100% 0%)",y:0,duration:.4,ease:"power2.in",onComplete:()=>{overlay.classList.remove("visible"),outOfFundsVisible=!1,document.body.classList.remove("menu-open");const partContainerEl=document.getElementById("part-container"),uiButtons=[document.getElementById("music-player"),document.getElementById("fullscreen-button"),document.getElementById("rotate-button"),document.getElementById("info-button"),document.getElementById("book-button")];[partContainerEl,...uiButtons].filter(el=>null!==el).forEach(el=>{el.style.transition="none"}),partContainerEl&&infoPanelEnabled&&gsap.to(partContainerEl,{opacity:1,duration:.3,ease:"power2.out",overwrite:!0}),uiButtons.forEach(btn=>{btn&&gsap.to(btn,{opacity:1,duration:.3,ease:"power2.out",overwrite:!0})})}}),gsap.to(backdrop,{opacity:0,duration:.3}),console.log("Out of funds popup hidden"))}window.addEventListener("keydown",event=>{if("Escape"===event.key){const lightbox=document.getElementById("wiki-image-lightbox");lightbox&&lightbox.classList.contains("visible")?lightboxNavigationHandlers&&lightboxNavigationHandlers.closeLightbox?lightboxNavigationHandlers.closeLightbox():(lightbox.classList.add("closing"),setTimeout(()=>{lightbox.classList.remove("visible","closing")},200)):outOfFundsVisible?hideOutOfFundsPopup():menuVisible?hidePartMenu():porscheHistoryVisible&&hidePorscheHistory()}});const loader=new FBXLoader;let porscheModel=null;function animate(){requestAnimationFrame(animate),grainTime+=.01,grainPass.uniforms.time.value=grainTime;const particles=scene.getObjectByName("ambientDust");if(particles&&particles.geometry){const positions=particles.geometry.attributes.position.array,velocities=particles.userData.velocities,originalPositions=particles.userData.originalPositions;for(let i=0;i<positions.length;i+=3){positions[i]+=velocities[i],positions[i+1]+=velocities[i+1],positions[i+2]+=velocities[i+2];const maxDistance=6;Math.sqrt(positions[i]*positions[i]+positions[i+2]*positions[i+2])>maxDistance&&(positions[i]=originalPositions[i],positions[i+1]=originalPositions[i+1],positions[i+2]=originalPositions[i+2])}particles.geometry.attributes.position.needsUpdate=!0;let targetColor=16766720;if(hoveredMesh){const hash=hoveredMesh.uuid.split("").reduce((a,b)=>(a=(a<<5)-a+b.charCodeAt(0))&a,0),statusCategory=Math.abs(hash)%3;targetColor=0===statusCategory?4521796:1===statusCategory?16729156:16766720}const colorDiff=targetColor-particles.userData.currentColor;Math.abs(colorDiff)>.1&&(particles.userData.currentColor+=.05*colorDiff,particles.material.color.setHex(particles.userData.currentColor))}if(boundingBoxAnimation.isAnimating&&boundingBoxHelper){const elapsed=performance.now()-boundingBoxAnimation.startTime,progress=Math.min(elapsed/boundingBoxAnimation.duration,1),easedProgress=easeOut(progress);boundingBoxAnimation.currentScale.lerpVectors(boundingBoxAnimation.startScale,boundingBoxAnimation.targetScale,easedProgress),boundingBoxHelper.scale.copy(boundingBoxAnimation.currentScale),boundingBoxAnimation.cornerIndicators.forEach(indicator=>{indicator.scale.copy(boundingBoxAnimation.currentScale)}),progress>=1&&(boundingBoxAnimation.isAnimating=!1,boundingBoxHelper.scale.set(1,1,1),boundingBoxAnimation.cornerIndicators.forEach(indicator=>{indicator.scale.set(1,1,1)}))}if(lockRing){if(lockRingAnim.active){const now=performance.now(),t=Math.min(1,(now-lockRingAnim.startTime)/lockRingAnim.duration),e=1-Math.pow(1-t,3),s=lockRingAnim.fromScale+(lockRingAnim.toScale-lockRingAnim.fromScale)*e,thick=lockRingAnim.fromThick+(lockRingAnim.toThick-lockRingAnim.fromThick)*e,op=lockRingAnim.fromOpacity+(lockRingAnim.toOpacity-lockRingAnim.fromOpacity)*e;if(lockRing.scale.set(s,s,s),lockRing.material.opacity=op,Math.abs(thick-lockRingThickness)>1e-4){lockRingThickness=thick;const baseR=lockRing.userData.baseRadius||1,segs=lockRing.userData.segments||32,newGeom=buildLockRingGeometry(baseR,lockRingThickness,segs);lockRing.geometry.dispose(),lockRing.geometry=newGeom}t>=1&&(lockRingAnim.active=!1)}if(porscheModel){const mb=(new THREE.Box3).setFromObject(porscheModel),mcenter=(mb.getSize(new THREE.Vector3),mb.getCenter(new THREE.Vector3));lockRing.position.set(mcenter.x,mcenter.y,mcenter.z),lockRing.rotation.y=porscheModel.rotation.y}}if(uiCogMesh)try{uiCogMesh.rotation.y+=.01,layoutUICog()}catch(_){}document.getElementById("part-info");if(cornerIndicators.length>0){const blinkSpeed=60,opacity=Math.sin(grainTime*blinkSpeed)>0?1:0;cornerIndicators.forEach(indicator=>{indicator.material&&(indicator.material.opacity=opacity,indicator.material.transparent=!0)})}if(cornerLabels.length>0){const width=window.innerWidth,height=window.innerHeight,world=new THREE.Vector3,ndc=new THREE.Vector3;cornerLabels.forEach(({anchor:anchor,el:el})=>{if(!anchor||!el)return;anchor.getWorldPosition(world),ndc.copy(world).project(camera);const x=(.5*ndc.x+.5)*width;let y=(.5*-ndc.y+.5)*height;y-=20,el.style.left=`${x}px`,el.style.top=`${y}px`,el.textContent=`X ${world.x.toFixed(2)}  Y ${world.y.toFixed(2)}  Z ${world.z.toFixed(2)}`})}const tooltipStatus=document.getElementById("tooltip-status"),tooltipIcon=document.getElementById("tooltip-icon");if(tooltipStatus&&tooltipStatus.classList.contains("blinking")){const blinkSpeed=60,opacity=Math.sin(grainTime*blinkSpeed)>0?1:0;tooltipStatus.style.opacity=opacity}if(tooltipIcon&&tooltipIcon.classList.contains("blinking")){const blinkSpeed=60,opacity=Math.sin(grainTime*blinkSpeed)>0?1:0;tooltipIcon.style.opacity=opacity}if(uiHoverBlinkTargets.length>0){const blinkSpeed=60,opacity=Math.sin(grainTime*blinkSpeed)>0?1:0;for(let i=0;i<uiHoverBlinkTargets.length;i++){const el=uiHoverBlinkTargets[i];el.classList.contains("ui-hover-blink")&&(el.style.opacity=opacity)}}if(orbitParents.length>0&&orbitParents.forEach(({parent:parent,spinSpeed:spinSpeed})=>{parent.rotation.y+=.01*spinSpeed}),scatteredCrosses.length>0&&scatteredCrosses.forEach(c=>{c.material&&(c.material.opacity=.55,c.material.transparent=!0)}),targetText.length>0){textDecodeIndex<targetText.length&&(textDecodeIndex+=textDecodeSpeed);const len=Math.min(Math.floor(textDecodeIndex),targetText.length);currentText=targetText.substring(0,len);const partNameEl=document.getElementById("part-name");partNameEl&&(partNameEl.textContent=currentText)}if(tooltipTypewriterActive&&tooltipTypewriterIndex<tooltipTargetText.length){tooltipTypewriterIndex+=tooltipTypewriterSpeed,tooltipTypewriterIndex>=tooltipTargetText.length&&(tooltipTypewriterIndex=tooltipTargetText.length),tooltipCurrentText=tooltipTargetText.substring(0,Math.floor(tooltipTypewriterIndex));const tooltipPartNameEl=document.getElementById("tooltip-part-name");tooltipPartNameEl&&(tooltipPartNameEl.textContent=tooltipCurrentText)}controls.update(),porscheModel&&autoRotateEnabled&&(porscheModel.rotation.y+=.005,porscheModel.traverse(child=>{child.isMesh&&child.material&&child.material.userData&&(child.material.userData.mouseX=mouseX,child.material.userData.mouseY=mouseY)})),composer.render()}function resetHoverStates(){if(hoveredMesh&&hoveredMesh.userData.originalMaterial){hoveredMesh.material&&hoveredMesh.material.dispose();const originalMat=hoveredMesh.userData.originalMaterial.clone();hoveredMesh.material=originalMat,hoveredMesh.userData.originalMaterial=null}hoveredMesh=null,hoverFadeProgress=0,warningMesh&&warningMesh.material&&void 0!==warningOriginalEmissive&&(warningMesh.material.emissive=warningOriginalEmissive.clone(),warningMesh.material.emissiveIntensity=warningOriginalEmissiveIntensity,warningMesh.material.needsUpdate=!0);const particles=scene.getObjectByName("ambientDust");particles&&particles.userData&&(particles.userData.currentColor=16766720,particles.material.color.setHex(16766720)),console.log("Hover states reset")}loader.load("Media/porsche_911.fbx",object=>{console.log("Porsche model loaded successfully"),object.scale.multiplyScalar(.01),console.log("=== FBX Model Parts ===");const meshInfo=[];object.traverse(child=>{if(child.isMesh){const bbox=(new THREE.Box3).setFromObject(child),center=bbox.getCenter(new THREE.Vector3),size=bbox.getSize(new THREE.Vector3),info={name:child.name,type:child.geometry.type,position:center,size:size,mesh:child};meshInfo.push(info);const matInfo=child.material?Array.isArray(child.material)?`[${child.material.length} mats]`:`Material: ${child.material.name||"unnamed"} | Color: ${child.material.color?.getHexString()||"N/A"}`:"No material";console.log(`Mesh: "${child.name}" | Type: ${child.geometry.type} | ${matInfo}`)}});const toRemove=[];object.traverse(child=>{if(child.isMesh){const name=child.name.toLowerCase();if(name.includes("podium")||name.includes("base")||name.includes("platform")||name.includes("stand")||name.includes("pedestal"))toRemove.push(child),console.log("Removing by name:",child.name);else{const bbox=(new THREE.Box3).setFromObject(child),size=bbox.getSize(new THREE.Vector3),center=bbox.getCenter(new THREE.Vector3);("CylinderGeometry"===child.geometry.type||"CircleGeometry"===child.geometry.type||"BoxGeometry"===child.geometry.type)&&Math.max(size.x,size.z)>Math.max(2*size.y)&&size.y<.3*Math.max(size.x,size.z)&&center.y<0&&(toRemove.push(child),console.log("Removing likely base by geometry:",child.name))}}}),toRemove.forEach(mesh=>{mesh.parent&&mesh.parent.remove(mesh),mesh.geometry.dispose(),mesh.material&&(Array.isArray(mesh.material)?mesh.material.forEach(mat=>mat.dispose()):mesh.material.dispose())});const partNameMap={carrosserie:"Body Panel",carosserie:"Body Panel",carroserie:"Body Panel",caroserie:"Body Panel",chassis:"Chassis Frame","châssis":"Chassis Frame",cadre:"Frame Structure",coque:"Body Shell",exterieur:"Exterior Panel","extérieur":"Exterior Panel",interieur:"Interior Panel","intérieur":"Interior Panel",porte:"Door Panel",portes:"Door Panel",capot:"Hood Panel",coffre:"Trunk Lid",pare:"Bumper",pare:"Windshield",grille:"Front Grille",vitre:"Window Glass",vitres:"Window Glass",fenetre:"Window Glass","fenêtre":"Window Glass",fenetres:"Window Glass","fenêtres":"Window Glass",retro:"Side Mirror","rétro":"Side Mirror",retroviseur:"Side Mirror","rétroviseur":"Side Mirror",siege:"Seat Assembly","siège":"Seat Assembly",sieges:"Seat Assembly","sièges":"Seat Assembly",volant:"Steering Wheel",tableau:"Dashboard",tableau:"Dashboard",console:"Center Console",pedale:"Pedal Assembly","pédale":"Pedal Assembly",pedales:"Pedal Assembly","pédales":"Pedal Assembly",frein:"Brake System",freins:"Brake System",roue:"Wheel Assembly",roues:"Wheel Assembly",pneu:"Tire",pneus:"Tire",jante:"Wheel Rim",jantes:"Wheel Rim",suspension:"Suspension System",suspensions:"Suspension System",amortisseur:"Shock Absorber",amortisseurs:"Shock Absorber",ressort:"Coil Spring",ressorts:"Coil Spring",moteur:"Engine Block",cylindre:"Cylinder Head",cylindres:"Cylinder Head",piston:"Piston Assembly",pistons:"Piston Assembly",vilebrequin:"Crankshaft",arbre:"Camshaft",soupape:"Valve System",soupapes:"Valve System",admission:"Intake Manifold",echappement:"Exhaust System","échappement":"Exhaust System",turbo:"Turbocharger",compresseur:"Supercharger",batterie:"Battery",alternateur:"Alternator",demarreur:"Starter Motor","démarreur":"Starter Motor",allumage:"Ignition System",bougie:"Spark Plug",bougies:"Spark Plug",bobine:"Ignition Coil",bobines:"Ignition Coil",fil:"Wiring Harness",fils:"Wiring Harness",fusible:"Fuse Box",fusibles:"Fuse Box",relais:"Relay Module",transmission:"Transmission",boite:"Gearbox","boîte":"Gearbox",embrayage:"Clutch Assembly",volant:"Flywheel",differentiel:"Differential","différentiel":"Differential",essieu:"Drive Axle",essieux:"Drive Axle",cardan:"Driveshaft",radiateur:"Radiator",refroidissement:"Coolant System",thermostat:"Thermostat",pompe:"Water Pump",ventilateur:"Cooling Fan",ventilateurs:"Cooling Fan",tuyau:"Coolant Hose",tuyaux:"Coolant Hose",carburant:"Fuel System",reservoir:"Fuel Tank","réservoir":"Fuel Tank",injecteur:"Fuel Injector",injecteurs:"Fuel Injector",filtre:"Fuel Filter",filtres:"Fuel Filter",ligne:"Fuel Line",lignes:"Fuel Line",air:"Air System",masse:"Mass Air Flow Sensor",papillon:"Throttle Body",phare:"Headlight",phares:"Headlight",feu:"Taillight",feux:"Taillight",clignotant:"Turn Signal",clignotants:"Turn Signal",antibrouillard:"Fog Light",antibrouillards:"Fog Light",led:"LED Light",aileron:"Spoiler",ailerons:"Spoiler",antenne:"Antenna",antennes:"Antenna",essuie:"Wiper Blade",essuie:"Wiper Blade",silencieux:"Muffler",catalyseur:"Catalytic Converter",capteur:"Sensor Unit",capteurs:"Sensor Unit",calculateur:"Engine Control Unit",abs:"ABS System",airbag:"Airbag System",airbags:"Airbag System",disque:"Brake Disc",disques:"Brake Disc",porterie:"Door Assembly",porteries:"Door Assembly",portiere:"Door Panel",portieres:"Door Panel",planche:"Dashboard",planches:"Dashboard",baguette:"Trim Strip",baguettes:"Trim Strip",enjo:"Wheel Hub",enjos:"Wheel Hub",body:"Body Panel",chassis:"Chassis Frame",frame:"Frame Structure",shell:"Body Shell",exterior:"Exterior Panel",engine:"Engine Block",motor:"Engine Motor",cylinder:"Cylinder Head",piston:"Piston Assembly",crankshaft:"Crankshaft",camshaft:"Camshaft",valve:"Valve System",intake:"Intake Manifold",exhaust:"Exhaust System",turbo:"Turbocharger",supercharger:"Supercharger",wheel:"Wheel Assembly",tire:"Tire",rim:"Wheel Rim",suspension:"Suspension System",shock:"Shock Absorber",spring:"Coil Spring",strut:"Strut Assembly",control:"Control Arm",brake:"Brake System",rotor:"Brake Rotor",caliper:"Brake Caliper",pad:"Brake Pad",seat:"Seat Assembly",dashboard:"Dashboard",steering:"Steering Wheel",pedal:"Pedal Assembly",console:"Center Console",door:"Door Panel",porte:"Door Panel",portiere:"Door Panel","portière":"Door Panel",porteri:"Door Panel",handle:"Door Handle",mirror:"Side Mirror",battery:"Battery",alternator:"Alternator",starter:"Starter Motor",ignition:"Ignition System",spark:"Spark Plug",coil:"Ignition Coil",wire:"Wiring Harness",fuse:"Fuse Box",relay:"Relay Module",transmission:"Transmission",gearbox:"Gearbox",levier:"Gearbox","levier de vitesse":"Gearbox","levier-vitesse":"Gearbox",clutch:"Clutch Assembly",flywheel:"Flywheel",differential:"Differential",axle:"Drive Axle",driveshaft:"Driveshaft",cv:"CV Joint",radiator:"Radiator",coolant:"Coolant System",thermostat:"Thermostat",water:"Water Pump",fan:"Cooling Fan",hose:"Coolant Hose",fuel:"Fuel System",tank:"Fuel Tank",pump:"Fuel Pump",injector:"Fuel Injector",filter:"Fuel Filter",line:"Fuel Line",air:"Air System",filter:"Air Filter",mass:"Mass Air Flow Sensor",throttle:"Throttle Body",glass:"Glass Panel",window:"Window Glass",windshield:"Windshield",windscreen:"Windscreen",rear:"Rear Window",side:"Side Window",light:"Light Assembly",headlight:"Headlight",taillight:"Taillight",brake:"Brake Light",turn:"Turn Signal",fog:"Fog Light",led:"LED Light",bumper:"Bumper",grille:"Front Grille",hood:"Hood Panel",trunk:"Trunk Lid",spoiler:"Spoiler",wing:"Rear Wing",antenna:"Antenna",wiper:"Wiper Blade",muffler:"Muffler",catalyst:"Catalytic Converter",sensor:"Sensor Unit",ecu:"Engine Control Unit",abs:"ABS System",airbag:"Airbag System"},namingBBox=(new THREE.Box3).setFromObject(object),namingCenter=namingBBox.getCenter(new THREE.Vector3),namingSize=namingBBox.getSize(new THREE.Vector3),namingMax=Math.max(namingSize.x,namingSize.y,namingSize.z);object.traverse(child=>{if(child.isMesh&&child.name){const originalName=child.name.toLowerCase();let renamed=!1;const cleanName=originalName.replace(/[0-9_\-\.]/g," ").replace(/\b(mesh|part|object|group|node|porsche|911)\b/g,"").trim(),deaccentName=(originalName||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[0-9_\-\.]/g," "),deaccentClean=(cleanName||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");for(const[key,englishName]of Object.entries(partNameMap)){const k=(key||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"");if(originalName.includes(key)||cleanName.includes(key)||deaccentName.includes(k)||deaccentClean.includes(k)){child.name=englishName,console.log(`Renamed: "${originalName}" -> "${englishName}"`),renamed=!0;break}}if(renamed&&"Gearbox"===child.name){const bbox=(new THREE.Box3).setFromObject(child),c=bbox.getCenter(new THREE.Vector3).sub(namingCenter),s=bbox.getSize(new THREE.Vector3),side=Math.abs(c.x)>.1*namingMax,panelLike=s.y>.6*s.x&&s.z<.8*namingMax;side&&panelLike&&(child.name="Door Panel")}if(!renamed){const words=cleanName.split(/\s+/).filter(word=>word.length>2&&!["part","mesh","object","group","node","porsche","911","car"].includes(word));if(words.length>0){const capitalizedWords=words.map(word=>word.charAt(0).toUpperCase()+word.slice(1));child.name=capitalizedWords.join(" "),console.log(`Generic rename: "${originalName}" -> "${child.name}"`)}else{const bbox=(new THREE.Box3).setFromObject(child),center=bbox.getCenter(new THREE.Vector3);bbox.getSize(new THREE.Vector3);center.y>.5?child.name="Upper Body Panel":center.y<-.5?child.name="Lower Body Panel":center.x>.3?child.name="Right Side Panel":center.x<-.3?child.name="Left Side Panel":child.name="Center Body Panel",console.log(`Position-based rename: "${originalName}" -> "${child.name}"`)}}}});const box=(new THREE.Box3).setFromObject(object),center=box.getCenter(new THREE.Vector3);object.position.sub(center),object.updateMatrixWorld(!0),object.traverse(n=>{(n.isMesh||n.isGroup)&&(n.userData.originalLocalMatrix=n.matrix.clone())}),object.traverse(n=>{if(n.userData&&n.userData.originalLocalMatrix&&(n.isMesh||n.isGroup)){const m=n.userData.originalLocalMatrix;n.matrix.copy(m),n.matrix.decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(!0)}});const glassMeshes=[];if(object.traverse(child=>{if(child.isMesh){const name=child.name.toLowerCase(),matName=(child.material?.name||"").toLowerCase();if(name.includes("glass")||name.includes("window")||name.includes("windshield")||name.includes("windscreen")||"glass"===matName||"window"===matName||"windshield"===matName){console.log("Converting to glass:",child.name,"Material:",child.material?.name),__sharedGlassMaterial?(__sharedGlassMaterial.envMap=scene.environment,__sharedGlassMaterial.opacity=.52,__sharedGlassMaterial.needsUpdate=!0):__sharedGlassMaterial=new THREE.MeshPhysicalMaterial({color:3355443,opacity:.52,transparent:!0,side:THREE.DoubleSide,roughness:0,metalness:1,envMapIntensity:1,envMap:scene.environment,clearcoat:1,clearcoatRoughness:0,sheen:2.5,sheenRoughness:.3,sheenColor:new THREE.Color(16766720),iridescence:1,iridescenceIOR:1.3,iridescenceThicknessRange:[100,500],depthWrite:!1}),Array.isArray(child.material)?child.material.forEach(mat=>mat.dispose()):child.material.dispose(),child.material=__sharedGlassMaterial,child.material.needsUpdate=!0,child.renderOrder=1e3,child.castShadow=!1,child.receiveShadow=!1,child.userData.isGlass=!0;const lname=(child.name||"").toLowerCase();(lname.includes("windshield")||lname.includes("windscreen"))&&(child.userData.displayName="Window Glass"),glassMeshes.push(child)}}}),glassMeshes.length>1){const groups=new Map,tmpBox=new THREE.Box3,tmpCenter=new THREE.Vector3;glassMeshes.forEach(m=>{tmpBox.setFromObject(m);const size=tmpBox.getSize(new THREE.Vector3);tmpBox.getCenter(tmpCenter);const key=[Math.round(50*tmpCenter.x)/50,Math.round(50*tmpCenter.y)/50,Math.round(50*tmpCenter.z)/50,Math.round(50*size.x)/50,Math.round(50*size.y)/50,Math.round(50*size.z)/50].join("|");groups.has(key)||groups.set(key,[]),groups.get(key).push(m)}),groups.forEach(arr=>{if(arr.length>1)for(let i=1;i<arr.length;i++)arr[i].visible=!1,arr[i].userData.hiddenAsDuplicateGlass=!0})}object.traverse(child=>{if(child.isMesh&&(child.castShadow=!0,child.receiveShadow=!0,child.material&&!child.userData.isGlass)){const baseColor=new THREE.Color(3355443);baseColor.multiplyScalar(1.2);const physicalMaterial=new THREE.MeshPhysicalMaterial({color:baseColor,opacity:.9,transparent:!0,roughness:0,metalness:1,envMapIntensity:1.2,envMap:scene.environment,clearcoat:1,clearcoatRoughness:0,sheen:2.5,sheenRoughness:.3,sheenColor:new THREE.Color(16766720),iridescence:1,iridescenceIOR:1.3,iridescenceThicknessRange:[100,500]});Array.isArray(child.material)?child.material.forEach(mat=>mat.dispose()):child.material.dispose(),child.material=physicalMaterial,child.material.side=THREE.DoubleSide,child.material.needsUpdate=!0}}),function(root){const candidates=[],tmp=new THREE.Vector3,modelBBox=(new THREE.Box3).setFromObject(root),modelSize=modelBBox.getSize(new THREE.Vector3),minExpectedRadius=.5*Math.max(modelSize.x,modelSize.z);if(root.traverse(child=>{if(!child.isMesh)return;const lname=(child.name||"").toLowerCase(),named=lname.includes("floor")||lname.includes("podium")||lname.includes("base")||lname.includes("platform")||lname.includes("stand")||lname.includes("pedestal")||lname.includes("disc")||lname.includes("circle"),bbox=(new THREE.Box3).setFromObject(child),size=bbox.getSize(tmp),score=(named?3:0)+(Math.abs(size.x-size.z)<=.12*Math.max(size.x,size.z)?2:0)+(size.y<=.08*Math.max(size.x,size.z)?1:0)+(Math.max(size.x,size.z)>=minExpectedRadius?1:0)+(bbox.getCenter(tmp).y<=modelBBox.getCenter(new THREE.Vector3).y+.5*size.y?1:0);score>0&&candidates.push({child:child,score:score,area:size.x*size.z})}),0===candidates.length)return;candidates.sort((a,b)=>b.score-a.score||b.area-a.area);const podiumMesh=candidates[0].child;scene.attach(podiumMesh),podiumMesh.name="Podium",podiumMesh.material=new THREE.MeshStandardMaterial({color:1710618,roughness:.5,metalness:.65,envMapIntensity:.45}),podiumMesh.material.side=THREE.DoubleSide,podiumMesh.material.needsUpdate=!0,podiumMesh.receiveShadow=!0,podiumMesh.castShadow=!1,podiumMesh.userData.isPodium=!0,podiumMesh.updateMatrixWorld(!0),console.log("[Podium]",{name:podiumMesh.name,uuid:podiumMesh.uuid}),function(podium){try{const pb=(new THREE.Box3).setFromObject(podium),psize=pb.getSize(new THREE.Vector3),pradius=.48*Math.max(psize.x,psize.z),center=pb.getCenter(new THREE.Vector3),y=pb.max.y+Math.max(.015*psize.y,.008)+.002,mirrorGeom=new THREE.CircleGeometry(pradius,128),mirror=new Reflector(mirrorGeom,{clipBias:.003,textureWidth:Math.max(256,Math.floor(.35*window.innerWidth)),textureHeight:Math.max(256,Math.floor(.35*window.innerHeight)),color:16777215,multisample:2});mirror.frustumCulled=!1;const worldPos=new THREE.Vector3(center.x,y,center.z),localPos=podium.worldToLocal(worldPos.clone());mirror.position.copy(localPos),mirror.rotation.set(0,0,0),mirror.material.transparent=!0,mirror.material.opacity=.04,mirror.material.depthWrite=!1,mirror.material.depthTest=!0,mirror.material.fog=!1,mirror.renderOrder=999,mirror.name="GroundReflection",mirror.material.uniforms&&mirror.material.uniforms.color&&mirror.material.uniforms.color.value.multiplyScalar(.5),function(m){const c=document.createElement("canvas");c.width=512,c.height=512;const ctx=c.getContext("2d"),grd=ctx.createRadialGradient(256,256,51.2,256,256,256);grd.addColorStop(0,"rgba(255,255,255,0.8)"),grd.addColorStop(.4,"rgba(255,255,255,0.2)"),grd.addColorStop(1,"rgba(255,255,255,0.005)"),ctx.fillStyle=grd,ctx.fillRect(0,0,512,512);const alphaTex=new THREE.CanvasTexture(c);alphaTex.colorSpace=THREE.SRGBColorSpace,m.alphaMap=alphaTex,m.needsUpdate=!0}(mirror.material),podium.add(mirror),mirror.visible=!0;try{const overlayGeom=mirrorGeom.clone(),overlayMat=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.5,side:THREE.DoubleSide,depthWrite:!1}),overlayDisc=new THREE.Mesh(overlayGeom,overlayMat);overlayDisc.position.copy(mirror.position),overlayDisc.position.y+=.001,overlayDisc.rotation.copy(mirror.rotation),overlayDisc.renderOrder=mirror.renderOrder+1,overlayDisc.name="GroundReflectionOverlay",overlayDisc.visible=!1,podium.add(overlayDisc)}catch(e){console.warn("Overlay disc add failed:",e)}try{const cylRadiusTop=.98*pradius,cylRadiusBottom=.98*pradius,cylHeight=Math.max(.02*psize.y,.01),cylGeom=new THREE.CylinderGeometry(cylRadiusTop,cylRadiusBottom,cylHeight,128,1,!0),cylMat=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.5,side:THREE.DoubleSide,depthWrite:!1}),darkCyl=new THREE.Mesh(cylGeom,cylMat);darkCyl.position.copy(mirror.position.clone()),darkCyl.position.y+=.5*cylHeight,darkCyl.renderOrder=1e3,darkCyl.name="PodiumDarkCylinder",podium.add(darkCyl),darkCyl.visible=!1}catch(e){console.warn("Dark cylinder add failed:",e)}}catch(e){console.warn("Ground reflection failed:",e)}}(podiumMesh)}(object),function(root){try{function deepDispose(object){object.traverse(o=>{o.geometry&&o.geometry.dispose?.(),o.material&&(Array.isArray(o.material)?o.material.forEach(m=>m?.dispose?.()):o.material.dispose?.())})}const wheels=[],bbox=(new THREE.Box3).setFromObject(root),center=bbox.getCenter(new THREE.Vector3);if(root.traverse(n=>{if(!n.isMesh&&!n.isGroup)return;const rootWheel=function(node){const isWheelName=nm=>nm.includes("wheel assembly")||nm.includes("wheel")||nm.includes("tire")||nm.includes("tyre")||nm.includes("rim")||nm.includes("roue")||nm.includes("pneu")||nm.includes("assembly");let cur=node,best=node;for(;cur&&cur.parent&&(cur.parent.isGroup||cur.parent.isObject3D);)isWheelName((cur.parent.name||"").toLowerCase())&&(best=cur.parent),cur=cur.parent;return best}(n);if(!rootWheel||rootWheel.__wheelCollected)return;const nm=(rootWheel.name||"").toLowerCase();if(!(nm.includes("wheel assembly")||nm.includes("wheel")||nm.includes("tire")||nm.includes("tyre")||nm.includes("rim")||nm.includes("roue")||nm.includes("pneu")||nm.includes("assembly")))return;const box=(new THREE.Box3).setFromObject(rootWheel),size=box.getSize(new THREE.Vector3),diag=size.length();if(!isFinite(diag)||0===diag)return;const c=box.getCenter(new THREE.Vector3);Math.abs(size.x-size.z)/Math.max(.001,Math.max(size.x,size.z))<.3&&size.y<.6*Math.max(size.x,size.z)&&(rootWheel.__wheelCollected=!0,wheels.push({node:rootWheel,center:c,size:size}))}),wheels.length<2)return void console.log("[WheelClone] Not enough wheel candidates found:",wheels.length);const left=wheels.filter(w=>w.center.x<center.x),right=wheels.filter(w=>w.center.x>=center.x);if(0===left.length||0===right.length)return void console.log("[WheelClone] Could not split wheels into left/right");function farthestAlongZ(arr){let best=arr[0],bestDist=Math.abs(arr[0].center.z-center.z);for(let i=1;i<arr.length;i++){const d=Math.abs(arr[i].center.z-center.z);d>bestDist&&(best=arr[i],bestDist=d)}return best}const leftRear=farthestAlongZ(left);let rightRear=farthestAlongZ(right);if(!leftRear||!rightRear)return void console.log("[WheelClone] Could not identify rear pair");const zDelta=Math.abs(leftRear.center.z-rightRear.center.z),sizeDelta=Math.abs(leftRear.size.length()-rightRear.size.length())/Math.max(.001,Math.max(leftRear.size.length(),rightRear.size.length()));console.log("[WheelClone] Candidates:",{leftRear:leftRear.node.name,rightRear:rightRear.node.name,zDelta:zDelta,sizeDelta:sizeDelta});let target=rightRear.node,targetParent=target.parent||root;target.updateWorldMatrix(!0,!0);const targetMatrixWorld=target.matrixWorld.clone(),targetPos=new THREE.Vector3,targetQuat=new THREE.Quaternion,targetScale=new THREE.Vector3;targetMatrixWorld.decompose(targetPos,targetQuat,targetScale);if(zDelta>.2*bbox.getSize(new THREE.Vector3).z||sizeDelta>.6){const leftWorld=new THREE.Vector3;leftRear.node.getWorldPosition(leftWorld),targetPos.set(center.x+Math.abs(leftWorld.x-center.x),leftWorld.y,leftWorld.z),targetQuat.copy(leftRear.node.getWorldQuaternion(new THREE.Quaternion)),targetScale.copy(leftRear.node.getWorldScale(new THREE.Vector3)),target=null,targetParent=root,console.log("[WheelClone] Using mirrored placement fallback at",targetPos.toArray())}const source=leftRear.node,clone=source.clone(!0);clone.updateMatrixWorld(!0);const wasVisible=clone.visible;if(scene.attach(clone),clone.position.copy(targetPos),clone.quaternion.copy(targetQuat),clone.scale.copy(targetScale),clone.updateMatrixWorld(!0),targetParent.attach(clone),target&&target.name&&(clone.name=target.name),clone.visible=wasVisible,target){target.userData.replacedByClone=!0;const parent=target.parent;deepDispose(target),parent?.remove(target)}else{const hideRadius=1.5*Math.max(leftRear.size.x,leftRear.size.z);wheels.forEach(w=>{if(w.center.distanceTo(targetPos)<hideRadius&&w.node!==source){w.node.userData.replacedByClone=!0;const parent=w.node.parent;deepDispose(w.node),parent?.remove(w.node)}})}console.log("[WheelClone] Replaced right-rear wheel with clone of left-rear:",{source:source.name,target:target?target.name:"(mirrored placement)"})}catch(err){console.warn("[WheelClone] Replacement failed:",err)}}(object),function(){if(lockRing)return;const podium=scene.getObjectByName("Podium"),modelBox=(new THREE.Box3).setFromObject(object),modelCenter=modelBox.getCenter(new THREE.Vector3);let radius=1,ringY=modelCenter.y;if(podium&&podium.isMesh){const psize=(new THREE.Box3).setFromObject(podium).getSize(new THREE.Vector3);radius=.5*Math.max(psize.x,psize.z)}else{const msize=modelBox.getSize(new THREE.Vector3);radius=.55*Math.max(msize.x,msize.z),ringY=modelCenter.y}const geom=buildLockRingGeometry(radius,lockRingThickness,32),mat=new THREE.LineBasicMaterial({color:16766720,transparent:!0,opacity:0});lockRing=new THREE.LineSegments(geom,mat),lockRing.position.set(modelCenter.x,ringY,modelCenter.z),lockRing.rotation.x=0,lockRing.userData.baseRadius=radius,lockRing.userData.segments=32,scene.add(lockRing)}(),function(root){const modelSize=(new THREE.Box3).setFromObject(root).getSize(new THREE.Vector3),down=.3*Math.max(modelSize.x,modelSize.y,modelSize.z);root.traverse(node=>{if(!node.isPoints)return;if(node.userData?.isHelper)return;const nm=(node.name||"").toLowerCase();if(nm.includes("podium")||nm.includes("floor")||nm.includes("base"))return;const bbox=(new THREE.Box3).setFromObject(node),sz=bbox.getSize(new THREE.Vector3),largest=Math.max(sz.x,sz.y,sz.z),nearOrigin=bbox.getCenter(new THREE.Vector3).length()<.05*Math.max(modelSize.x,modelSize.y,modelSize.z),small=largest<.03*Math.max(modelSize.x,modelSize.y,modelSize.z),vertCount=node.geometry?.attributes?.position?.count||0;if(nearOrigin&&small||vertCount>0&&vertCount<30){const worldPos=new THREE.Vector3;if(node.getWorldPosition(worldPos),worldPos.y-=down,node.parent){const localPos=node.parent.worldToLocal(worldPos.clone());node.position.copy(localPos)}else node.position.copy(worldPos);node.updateMatrixWorld(!0),node.userData.isSunk=!0}})}(object),scene.add(object),porscheModel=object,assetsReady=!0;const size=box.getSize(new THREE.Vector3),maxDim=Math.max(size.x,size.y,size.z);modelMaxDimension=maxDim;const sphereRadius=.8*maxDim,sphereGeometry=new THREE.SphereGeometry(sphereRadius,32,16),sphereEdges=new THREE.EdgesGeometry(sphereGeometry),sphereWireframe=new THREE.LineSegments(sphereEdges,new THREE.LineBasicMaterial({color:16766720,transparent:!0,opacity:.6}));sphereWireframe.position.copy(object.position),sphereWireframe.name="referenceSphere",sphereWireframe.userData.isHelper=!0,scene.add(sphereWireframe),camera.position.set(.3825*maxDim,.3078*maxDim,.3825*maxDim),controls.target=new THREE.Vector3(0,0,0),controls.update(),window.camera=camera,window.controls=controls,function(root){const modelCenter=(new THREE.Box3).setFromObject(root).getCenter(new THREE.Vector3),tmpVec=new THREE.Vector3,normal=new THREE.Vector3;root.traverse(mesh=>{if(!mesh.isMesh||!mesh.geometry)return;const geom=mesh.geometry;geom.attributes.normal||geom.computeVertexNormals();const pos=geom.attributes.position,nrm=geom.attributes.normal;if(!pos||!nrm)return;const step=Math.max(1,Math.floor(pos.count/200));let dotSum=0;for(let i=0;i<pos.count;i+=step){tmpVec.set(pos.getX(i),pos.getY(i),pos.getZ(i)),mesh.localToWorld(tmpVec),normal.set(nrm.getX(i),nrm.getY(i),nrm.getZ(i)),normal.transformDirection(mesh.matrixWorld);const toOutside=tmpVec.clone().sub(modelCenter).normalize();dotSum+=normal.dot(toOutside)}})}(object);const allMeshes=[];object.traverse(child=>{child.isMesh&&!child.name.toLowerCase().includes("glass")&&(allMeshes.push(child),child.userData.originalMaterial=child.material.clone())});let wireframeCycleData={allMeshes:allMeshes,currentMeshIndex:0,transitionProgress:0,transitionSpeed:.1};const wireframeMaterial=new THREE.MeshStandardMaterial({color:16737792,wireframe:!0,emissive:16737792,emissiveIntensity:7.5});object.userData.wireframeCycle=wireframeCycleData,object.userData.wireframeMaterial=wireframeMaterial;const particleGeometry=new THREE.BufferGeometry,positions=new Float32Array(360),velocities=new Float32Array(360),ranges=new THREE.Vector3(5,3,5);for(let i=0;i<120;i++)positions[3*i+0]=(2*Math.random()-1)*ranges.x,positions[3*i+1]=(2*Math.random()-1)*ranges.y+.5,positions[3*i+2]=(2*Math.random()-1)*ranges.z,velocities[3*i+0]=.02*(Math.random()-.5),velocities[3*i+1]=.01*(Math.random()-.5),velocities[3*i+2]=.02*(Math.random()-.5);particleGeometry.setAttribute("position",new THREE.BufferAttribute(positions,3)),particleGeometry.setAttribute("velocity",new THREE.BufferAttribute(velocities,3));const particleMaterial=new THREE.PointsMaterial({color:16766720,size:.03,sizeAttenuation:!0,transparent:!0,opacity:.9}),particles=new THREE.Points(particleGeometry,particleMaterial);particles.name="ambientDust",particles.userData={originalPositions:positions.slice(),velocities:velocities,currentColor:16766720},scene.add(particles);const ghostGroup=new THREE.Group;ghostGroup.name="ghostPointCloud",ghostGroup.userData.isHelper=!0;const ghostMaterial=new THREE.PointsMaterial({color:16766720,size:.02,sizeAttenuation:!0,transparent:!0,opacity:.28,depthWrite:!1,blending:THREE.AdditiveBlending});object.traverse(child=>{if(child.isMesh&&child.geometry){const geom=child.geometry;if(geom.attributes&&geom.attributes.position){const pos=geom.attributes.position,count=pos.count,stride=10,newCount=Math.max(1,Math.floor(count/stride)),sampled=new Float32Array(3*newCount);let w=0;for(let i=0;i<count&&w<newCount;i+=stride)sampled[3*w+0]=pos.getX(i),sampled[3*w+1]=pos.getY(i),sampled[3*w+2]=pos.getZ(i),w++;const ghostGeom=new THREE.BufferGeometry;ghostGeom.setAttribute("position",new THREE.BufferAttribute(sampled,3));const bbox=(new THREE.Box3).setFromObject(child),sz=bbox.getSize(new THREE.Vector3),largest=Math.max(sz.x,sz.y,sz.z),nearOrigin=bbox.getCenter(new THREE.Vector3).length()<.03*modelMaxDimension;if(largest<.01*modelMaxDimension&&nearOrigin)return;const points=new THREE.Points(ghostGeom,ghostMaterial.clone());points.position.copy(child.position),points.rotation.copy(child.rotation),points.scale.copy(child.scale),points.matrix.copy(child.matrix),points.matrixAutoUpdate=!1,points.frustumCulled=!0,points.userData.isHelper=!0,ghostGroup.add(points)}}}),object.add(ghostGroup),ghostGroup.visible=!1,createPlanetaryOrbitsAround(object),createScatteredCrossesAround(object,32);let candidate=null;if(object.traverse(child=>{if(child.isMesh){const lname=(child.name||"").toLowerCase();candidate||(candidate=child),(lname.includes("wheel")||lname.includes("tire")||lname.includes("rim"))&&(candidate=child)}}),candidate&&candidate.material){warningMesh=candidate;let baseMat=candidate.material;Array.isArray(baseMat)&&(baseMat=baseMat[0]),baseMat=baseMat.isMeshStandardMaterial||baseMat.isMeshPhysicalMaterial?baseMat.clone():new THREE.MeshStandardMaterial({color:baseMat.color||new THREE.Color(2236962)}),warningOriginalEmissive=baseMat.emissive?baseMat.emissive.clone():new THREE.Color(0),warningOriginalEmissiveIntensity=baseMat.emissiveIntensity||0,baseMat.emissive=new THREE.Color(16711680),baseMat.emissiveIntensity=0,warningMesh.material=baseMat,warningMesh.material.needsUpdate=!0}},progress=>{console.log("Loading progress:",progress.loaded/progress.total*100+"%")},error=>{console.error("Error loading Porsche model:",error)}),initializeMusicPlayer(),setTimeout(resetHoverStates,1e3),initializeFullscreen(),initializeInfoToggle(),initializeUICog(),initializeRotateToggle(),initializeBookButton(),initializeUIHoverBlink(),function(){const overlay=document.getElementById("loading-overlay"),text=document.getElementById("loading-text");if(!overlay)return;const start=performance.now(),tick=()=>{const elapsed=performance.now()-start;assetsReady&&elapsed>=1200?(document.querySelectorAll(".ui-fade").forEach(el=>el.classList.add("visible")),text&&(text.style.display="none"),setTimeout(()=>{overlay.classList.add("hidden"),setTimeout(()=>{try{overlay.remove()}catch(_){}},1900)},200)):requestAnimationFrame(tick)};requestAnimationFrame(tick)}(),animate(),window.addEventListener("resize",()=>{fisheyePass&&(fisheyePass.uniforms.aspectRatio.value=window.innerWidth/window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight),composer.setSize(window.innerWidth,window.innerHeight)});